<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[];gtag(`js`,new Date());gtag(`config`,`G-GTB0KMLN90`)</script><title>ğŸ“• Asynchronous Programming in Rustã‚’èª­ã‚“ã æ„Ÿæƒ³ | Happy developing</title><meta content="CF Samsonå…ˆç”Ÿã®Futureè§£èª¬ãŒã¤ã„ã«æœ¬ã«ãªã£ãŸ" name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ“• Asynchronous Programming in Rustã‚’èª­ã‚“ã æ„Ÿæƒ³" name=twitter:title><meta content="CF Samsonå…ˆç”Ÿã®Futureè§£èª¬ãŒã¤ã„ã«æœ¬ã«ãªã£ãŸ" name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/closed_book.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ“• Asynchronous Programming in Rustã‚’èª­ã‚“ã æ„Ÿæƒ³</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2024-03-14<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/book/>book</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#du-ndaben>èª­ã‚“ã æœ¬</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#matome>ã¾ã¨ã‚</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-1-concurrency-and-asynchronous-programming-a-detailed-overview>Chapter 1: Concurrency and Asynchronous Programming: a Detailed Overview</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-2-how-programming-languages-model-asynchronous-program-flow>Chapter 2: How Programming Languages Model Asynchronous Program Flow</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-3-understanding-os-backed-event-queues-system-calls-and-cross-platform-abstractions>Chapter 3: Understanding OS-Backed Event Queues, System Calls, and Cross-Platform Abstractions</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-4-create-your-own-event-queue>Chapter 4: Create Your Own Event Queue</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-5-creating-our-own-fibers>Chapter 5: Creating Our Own Fibers</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-6-futures-in-rust>Chapter 6: Futures in Rust</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-7-coroutines-and-async-await>Chapter 7: Coroutines and async/await</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-8-runtimes-wakers-and-the-reactor-executor-pattern>Chapter 8: Runtimes, Wakers, And The Reactor-Executor Pattern</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-9-coroutines-self-referential-struct-and-pinning>Chapter 9: Coroutines, Self-Referential Struct, And Pinning</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-10-creating-your-own-runtime>Chapter 10: Creating Your Own Runtime</a></ul></nav></aside><div class=entry-content><h2 id=du-ndaben><a aria-label="Anchor link for: du-ndaben" class=zola-anchor href=#du-ndaben>èª­ã‚“ã æœ¬</a></h2><a href=https://www.packtpub.com/product/asynchronous-programming-in-rust/9781805128137> <figure><div class=fig-images-row><img , alt src=images/apir-book.jpg></div><figcaption>Asynchronous Programming in Rust</figcaption></figure> </a><p>è‘—è€…: <a href="https://github.com/PacktPublishing/Asynchronous-Programming-in-Rust/tree/main?tab=readme-ov-file#get-to-know-the-author">Carl Fredrik Samson</a><br> <a href="https://github.com/PacktPublishing/Asynchronous-Programming-in-Rust/tree/main?tab=readme-ov-file#get-to-know-the-author">Sample code Repository</a><p>ä»Šã¯ã‚‚ã†èª­ã‚ãªããªã£ã¦ã—ã¾ã£ãŸ<a href=http://web.archive.org/web/20230324130904/https://cfsamson.github.io/books-futures-explained/>Futures Explained in 200 Lines of Rust</a>ã‚„<a href=http://web.archive.org/web/20220814154139/https://cfsamson.github.io/book-exploring-async-basics/introduction.html>Exploring Async Basics with Rust</a>ã‚’æ›¸ã‹ã‚ŒãŸCF Samsonå…ˆç”ŸAsyncè§£èª¬æœ¬ãŒã¤ã„ã«å‡ºç‰ˆã•ã‚Œã¾ã—ãŸã€‚<p>æœ¬è¨˜äº‹ã§ã¯æœ¬æ›¸ã‚’èª­ã‚“ã æ„Ÿæƒ³ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>Rustã®Future,async/awaitã®è§£èª¬ã¨ã—ã¦éå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚ æœ€çµ‚çš„ã«<a href=https://github.com/tokio-rs/mio>mio</a>ã®ã¿ã®ä¾å­˜ã§ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãŒå‹•ãruntimeã‚’ä½œã‚Œã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> executor <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">runtime<span class="z-punctuation z-accessor z-rust">::</span></span>init<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    executor<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">block_on</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-function z-rust">async_main</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">async <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">async_main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> txt <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Http<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/600/HelloAsyncAwait<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{txt}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> txt <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Http<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/400/HelloAsyncAwait<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{txt}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>æœ¬æ›¸ãŒç´ æ™´ã‚‰ã—ã„ã®ã¯ã€Futureã‚’èª¬æ˜ã™ã‚‹ãŸã‚ã«assembly,ISA,thread,systemcall,epoll,calling convention, green thread, coroutineã¨ã„ã£ãŸæ¦‚å¿µã‹ã‚‰èª¬æ˜ã—ã¦ãã‚Œã‚‹ç‚¹ã§ã™ã€‚1ç« ã‹ã‚‰5ç« ã¾ã§ã¯Rustã‚’ã‚„ã£ã¦ã„ãªãã¦ã‚‚å‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚<h2 id=chapter-1-concurrency-and-asynchronous-programming-a-detailed-overview><a aria-label="Anchor link for: chapter-1-concurrency-and-asynchronous-programming-a-detailed-overview" class=zola-anchor href=#chapter-1-concurrency-and-asynchronous-programming-a-detailed-overview>Chapter 1: Concurrency and Asynchronous Programming: a Detailed Overview</a></h2><p>æœ¬æ›¸ã®å‰æã¨ãªã‚‹Multitaskingã®æ­´å²ã‚„è¨€è‘‰ã®å®šç¾©ã€OSã¨CPUã®é–¢ä¿‚ç­‰ãŒèª¬æ˜ã•ã‚Œã¾ã™ã€‚<br> Preemptiveã®æ¦‚å¿µã‚„æœ¬æ›¸ã«ãŠã‘ã‚‹concurrencyã¨parallelismã®é•ã„ãŒå–ã‚Šä¸Šã’ã‚‰ã‚Œã¾ã™ã€‚ã€€ã€€ Efficiency(ç„¡é§„ã‚’é¿ã‘ã‚‹èƒ½åŠ›)ã¨ã„ã†è¦³ç‚¹ã‹ã‚‰ã¿ã‚‹ã¨ã€parallelism(ä¸¦åˆ—)ã¯efficiencyã«ã¯ä¸€åˆ‡å¯„ä¸ã›ãšã€concurrency(ä¸¦è¡Œ)ã“ããŒã€ãã‚Œã‚’é«˜ã‚ã‚‹ã¨ã„ã†èª¬æ˜ãŒãŠã‚‚ã—ã‚ã‹ã£ãŸã§ã™ã€‚<br> Concurrency,parallelism,resource,task,asynchronous programmingã¨ã„ã£ãŸã¨ã‚‚ã™ã‚Œã°å¤šç¾©çš„ã§æ–‡è„ˆä¾å­˜ãªç”¨èªã‚’æœ¬æ›¸ã®ç¯„å›²ã§ã€ãã¡ã‚“ã¨å®šç¾©ã—ã¦ãã‚Œã‚‹ã¨ã“ã‚ã‚‚ã‚ˆã‹ã£ãŸã§ã™ã€‚<br> ä¸€æ–¹ã§ã€<blockquote><p>On the other hand, if you fancy heated internet debates, this is a good place to start. Just claim someone elseâ€™s definition of concurrent is 100 % wrong or that yours is 100 % correct, and off you go.</blockquote><p>(ãƒãƒƒãƒˆä¸Šã§ã®è­°è«–ãŒå¥½ããªã‚‰ã€èª°ã‹ã®concurrentã®å®šç¾©ã¯ã¾ã£ãŸãã®èª¤ã‚Šã§ã€æ­£ã—ãã¯ã“ã†ã¨ä¸»å¼µã—ã¦ã¿ã‚‹ã¨ã„ã„ã ã‚ã†)<p>ã¨ã„ã†å†—è«‡ã‚‚ã‚ã‚Šã€ã‚‚ã‚ã‚‚ã‚ã®å®šç¾©ã¯ã‚ãã¾ã§æœ¬æ›¸ã®ç†è§£ã‚’åŠ©ã‘ã‚‹ãŸã‚ã«ã—ã¦ã„ã‚‹ã¨ã„ã†ã‚¹ã‚¿ãƒ³ã‚¹ã§ã™ã€‚ (æ—¥æœ¬ä»¥å¤–ã§ã‚‚ä¸¦åˆ—/ä¸¦è¡Œè­¦å¯Ÿã£ã¦ã„ã‚‹ã‚“ã§ã™ã­)<p>Readã®I/Oã‚’è¡Œã†å ´åˆã«3ã¤ã®é¸æŠè‚¢ãŒã‚ã‚Šã€ãã‚Œãã‚Œthreadã‚’suspendã™ã‚‹ã‹ã ã£ãŸã‚Šã®é•ã„ãŒå›³ã§è§£èª¬ã•ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã‚‚ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚epollç­‰ã«ã¤ã„ã¦ã¯3ç« ã§è©³ã—ãèª¬æ˜ã—ã¦ãã‚Œã¾ã™ã€‚<p>Rustã®æœ¬ãªã®ã«Futureã®è©±ãŒã§ã¦ãã‚‹ã®ãŒ6ç« ãªã®ãŒç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚ã¾ãŸã€firmwareã«ã¯microcontroller(small CPU)ãŒå‚™ã‚ã£ã¦ãŠã‚Šã€concurrencyã¨ã¯åŠ¹ç‡æ€§ã‚’ä¸Šã’ã‚‹ã“ã¨ãªã®ã ã‹ã‚‰ã€åŒã˜ä»•äº‹ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã•ã›ãªã„ã¨ã„ã†è©±ã¯ã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚<br> çŸ¥ã£ã¦ã„ã‚‹äººã«ã¨ã£ã¦ã¯å½“ãŸã‚Šå‰ãªã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã“ã®ã‚ãŸã‚Šã‚’èª¬æ˜ã—ã¦ãã‚Œã‚‹ã®ã¯çã—ã„ã¨æ€ã„ã¾ã—ãŸã€‚<h2 id=chapter-2-how-programming-languages-model-asynchronous-program-flow><a aria-label="Anchor link for: chapter-2-how-programming-languages-model-asynchronous-program-flow" class=zola-anchor href=#chapter-2-how-programming-languages-model-asynchronous-program-flow>Chapter 2: How Programming Languages Model Asynchronous Program Flow</a></h2><p>OSã®threadã¨ã„ã†æ©Ÿæ§‹ãŒã‚ã‚‹ã®ã«ãªãœã€ã•ã‚‰ã«ã‚‚ã†1ã¤æŠ½è±¡åŒ–ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¨­ã‘ã‚‹ã®ã‹ã€ Thread,future,goroutine, promiseç­‰ãŒãªã«ã‚’æŠ½è±¡åŒ–ã—ã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦èª¬æ˜ã•ã‚Œã¾ã™ã€‚<br> Cooperativeã‚„stackfulã¨ã„ã£ãŸåˆ†é¡ã®è¦³ç‚¹ã®èª¬æ˜ã‚‚ã‚ã‚Šã¾ã™ã€‚<br> OS threadã¨user-lebel thread(green thread)ã®å…±é€šç‚¹ã‚„é•ã„ã®èª¬æ˜ã‚‚ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚<br> Green threadã§ã¯program(runtime)ã§green threadã”ã¨ã®stackã‚’ç®¡ç†ã—ã¾ã™ãŒã€æœ€åˆã®å‰²ã‚Šå½“ã¦ãŒè¶³ã‚Šãªããªã£ãŸå ´åˆã«æ–°ã—ã„é ˜åŸŸã‚’å‰²ã‚Šå½“ã¦ã¦ç§»å‹•ã•ã›ã‚‹ã“ã¨ã®é›£ã—ã•ã«ã¤ã„ã¦ã®è¨€åŠã¯ãªã‚‹ã»ã©ã§ã—ãŸã€‚(stackã‚’å˜ç´”ã«ç§»å‹•ã•ã›ã‚‹ã¨pointerãŒå£Šã‚Œã¦ã—ã¾ã„ã¾ã™ãŒã€garbage collectorã§ã©ã®ã¿ã¡pointerã‚’ç®¡ç†ã™ã‚‹ã‚³ã‚¹ãƒˆã‚’æ‰•ã£ã¦ã„ã‚‹ç­‰)<p>Green thread, fiber, future, promiseãŒã©ã†ã„ã£ãŸé–¢ä¿‚ã«ã‚ã‚‹ã®ã‹æ•´ç†ã•ã‚Œã¦ãŠã‚Šã€æœ¬ç« ã‚‚Rusté–¢ä¿‚ãªãå‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚green threadã„ã¾ã„ã¡ãƒ”ãƒ³ã¨ãã¦ã„ãªã„æ–¹ã‚‚5ç« ã§å®Ÿéš›ã«ä½œã‚ŠãªãŒã‚‰è©³ã—ãè§£èª¬ã—ã¦ãã‚Œã‚‹ã®ã§å¤§ä¸ˆå¤«ã§ã™ã€‚<h2 id=chapter-3-understanding-os-backed-event-queues-system-calls-and-cross-platform-abstractions><a aria-label="Anchor link for: chapter-3-understanding-os-backed-event-queues-system-calls-and-cross-platform-abstractions" class=zola-anchor href=#chapter-3-understanding-os-backed-event-queues-system-calls-and-cross-platform-abstractions>Chapter 3: Understanding OS-Backed Event Queues, System Calls, and Cross-Platform Abstractions</a></h2><p><a href=https://github.com/tokio-rs/mio>mio</a>ã‚„<a href=https://github.com/smol-rs/polling>polling</a>,<a href=https://libuv.org/>libuv</a>ç­‰ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹OS-backed event queueã«ã¤ã„ã¦ã€‚<p>Blocking I/Oã‚’è¡Œã†ã¨ã€ãã®OS threadã¯suspendã•ã‚Œã€dataãŒåˆ°ç€ã™ã‚‹ã¨å†ã³èµ·ã“ã•ã‚Œã€CPUã®stateã‚’å¾©å…ƒã—ãŸã®ã¡ã€å®Ÿè¡ŒãŒå†é–‹ã•ã‚Œã‚‹ã€‚I/Oã®å®Œäº†ã‚’å¾…ã£ã¦ã„ã‚‹é–“ã«ä»–ã«ã™ã‚‹ã“ã¨ãŒãªã‘ã‚Œã°ã“ã®ä»•çµ„ã¿ã¯åŠ¹ç‡çš„ã ãŒã€ãã†ã§ãªã„å ´åˆã¯æ–°ãŸã«threadã‚’èµ·å‹•ã•ã›ã‚‹ã—ã‹ãªã„ã€‚<br> ãã“ã§ã€threadã‚’suspendã•ã›ãªã„syscallã‚’è¡Œã„ã€blockã™ã‚‹ä»£ã‚ã‚Šã«eventã®çŠ¶æ…‹ã‚’å•ã„åˆã‚ã›ã‚‹ãŸã‚ã®handleã‚’å–å¾—ã™ã‚‹ã€‚(polling)ã€‚ãŸã ã—ã€ã“ã®æ‰‹æ³•ã ã¨ã€pollã®é–“éš”ãŒçŸ­ã™ãã‚‹ã¨CPUã‚’æµªè²»ã—ã¦ã—ã¾ã†ã—ã€é•·ã™ãã‚‹ã¨throughputãŒè½ã¡ã¦ã—ã¾ã†ã€‚ãã“ã§ã€epoll,kqueue,IOCPç­‰ã®event queueã‚’åˆ©ç”¨ã™ã‚‹ã€‚<p>event queueã«ã¯ã€I/Oã®æº–å‚™ãŒã§ããŸã“ã¨ã‚’é€šçŸ¥ã™ã‚‹Readiness basedã¨bufferç­‰ã‚’æ¸¡ã—ã¦I/Oã®å®Œäº†ã‚’é€šçŸ¥ã™ã‚‹Completion basedãªã‚‚ã®ãŒã‚ã‚‹ã€‚epollã¨input/output completion port(IOCP)ã‚’å…·ä½“ä¾‹ã«ä¸¡è€…ã®èª¬æ˜ã‚‚ã‚ã‚‹ã€‚cross platformãªevent queue apiã‚’ä½œã‚‹éš›ã¯ã©ã¡ã‚‰ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹ã‹æ±ºã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã€ä¸ä¸€è‡´ã‚’åŸ‹ã‚ã‚‹ã®ã¯ãªã‹ãªã‹å¤§å¤‰ã¨ã„ã†èª¬æ˜ã‚‚ã‚ã‚Šã¾ã™ã€‚<p>å¾ŒåŠã§ã¯syscallã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚ABIã‚„calling conventionã‚‚èª¬æ˜ã—ã¦ãã‚Œã¾ã™ã€‚<br> Rustã‹ã‚‰system callã‚’è¡Œã†æ–¹æ³•ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãª<code>asm!</code> macroã‚„FFIãŒç´¹ä»‹ã•ã‚Œã¾ã™ã€‚<br> <code>asm!</code> macroã«ã¤ã„ã¦ã¯è©³ã—ã„è§£èª¬ã‚‚ã‚ã‚Šã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">inline</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">never</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">syscall</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">message</span><span class="z-punctuation z-separator z-rust">:</span> String</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â <span class="z-storage z-type z-rust">let</span> msg_ptr <span class="z-keyword z-operator z-assignment z-rust">=</span> message<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">as_ptr</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â <span class="z-storage z-type z-rust">let</span> len <span class="z-keyword z-operator z-assignment z-rust">=</span> message<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">len</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">Â Â Â Â Â Â Â Â <span class="z-support z-macro z-rust">asm!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">Â Â Â Â Â Â Â Â Â Â Â Â <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>mov rax, 1<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">Â Â Â Â Â Â Â Â Â Â Â Â <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>mov rdi, 1<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">Â Â Â Â Â Â Â Â Â Â Â Â <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>syscall<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">Â Â Â Â Â Â Â Â Â Â Â Â <span class="z-keyword z-operator z-rust">in</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>rsi<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> msg_ptr<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">Â Â Â Â Â Â Â Â Â Â Â Â <span class="z-keyword z-operator z-rust">in</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>rdx<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> len<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">Â Â Â Â Â Â Â Â Â Â Â Â <span class="z-support z-function z-rust">out</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>rax<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">Â Â Â Â Â Â Â Â Â Â Â Â <span class="z-support z-function z-rust">out</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>rdi<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">Â Â Â Â Â Â Â Â Â Â Â Â <span class="z-support z-function z-rust">lateout</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>rsi<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">Â Â Â Â Â Â Â Â Â Â Â Â <span class="z-support z-function z-rust">lateout</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>rdx<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">_</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">Â Â Â Â Â Â Â Â </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">Â Â Â Â </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><h2 id=chapter-4-create-your-own-event-queue><a aria-label="Anchor link for: chapter-4-create-your-own-event-queue" class=zola-anchor href=#chapter-4-create-your-own-event-queue>Chapter 4: Create Your Own Event Queue</a></h2><p>æœ¬ç« ã§ã¯ã€epollã‚’ç”¨ã„ã¦ã€ç°¡å˜ãªevent queueã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚<br> ã“ã®ä¾‹ã¯<a href=https://github.com/tokio-rs/mio>mio</a>ã«åŸºã¥ã„ã¦ã„ã¦ã€mioã®ç†è§£ã«ã‚‚ç¹«ã‚‹è¦ªåˆ‡è¨­è¨ˆã§ã™ã€‚<p>å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿéš›ã«epollã‚’åˆ©ç”¨ã—ãŸ<code>Poll</code>ã‚’å®Ÿè£…ã—ãªãŒã‚‰ã€epollã®ä»•çµ„ã¿ãŒè§£èª¬ã•ã‚Œã¾ã™ã€‚<br> ã¾ãŸã€<code>#[repr(packed)]</code>ã‚„bitflags, level-triggerã¨edge-trigger, <code>TcpStream::set_nodelay</code>ã¨ã„ã£ãŸé–¢é€£ã™ã‚‹å‰æã«ã¤ã„ã¦ã®èª¬æ˜ã‚‚ã‚ã‚Šã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">link</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">name <span class="z-keyword z-operator z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>c<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">extern</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>C<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">epoll_wait</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">epfd</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i32</span>, <span class="z-variable z-parameter z-rust">events</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-rust">*mut</span> Event, <span class="z-variable z-parameter z-rust">maxevents</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i32</span>, <span class="z-variable z-parameter z-rust">timeout</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i32</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">i32</span></span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Poll</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">poll</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">events</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> Events, <span class="z-variable z-parameter z-rust">timeout</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> res <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> <span class="z-support z-function z-rust">epoll_wait</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>fd<span class="z-punctuation z-separator z-rust">,</span> events<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">as_mut_ptr</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span> max_events<span class="z-punctuation z-separator z-rust">,</span> timeout</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ä¸Šè¨˜ã®epollã‚’åˆ©ç”¨ã—ãŸå…·ä½“ä¾‹ã®ä»–ã«ã‚‚åŒã˜å‡¦ç†ã‚’<a href=https://github.com/tokio-rs/mio>mio</a>ã‚’åˆ©ç”¨ã—ãŸversionã®å…·ä½“ä¾‹ã‚‚è¼‰ã£ã¦ãŠã‚Šã€<a href=https://github.com/tokio-rs/mio>mio</a>ã‚ˆãã‚ã‹ã‚‰ãªã„ã¨æ€ã£ã¦ã„ãŸè‡ªåˆ†ã«ã¨ã£ã¦ã¯éå¸¸ã«ã‚ã‚ŠãŒãŸã„ç« ã¨ãªã£ã¦ãŠã‚Šã¾ã—ãŸã€‚<h2 id=chapter-5-creating-our-own-fibers><a aria-label="Anchor link for: chapter-5-creating-our-own-fibers" class=zola-anchor href=#chapter-5-creating-our-own-fibers>Chapter 5: Creating Our Own Fibers</a></h2><p>æœ¬ç« ã§ã¯ã€fiber, green threadã¨ã„ã‚ã‚Œã‚‹stackful coroutineã‚’ä½œã‚Šã¾ã™ã€‚<br> green threadã¨ã¯è¦ã™ã‚‹ã«ã€programã§assemblyã‚’æ›¸ã„ã¦ã€CPUã®registerç‰¹ã«stack pointerã‚„instruction pointerã‚’æ›¸ãæ›ãˆã¦å®Ÿè¡Œã™ã‚‹å‘½ä»¤æµã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã„ã†ã®ãŒè‡ªåˆ†ã®ç†è§£ã§ã™ã€‚<p>å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«threadã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å®šç¾©ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">PartialEq<span class="z-punctuation z-separator z-rust">,</span> Eq<span class="z-punctuation z-separator z-rust">,</span> Debug</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">State</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">  Available<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">  Running<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">  Ready<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Thread</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">  <span class="z-variable z-other z-member z-rust">stack</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-type z-rust">u8</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">  <span class="z-variable z-other z-member z-rust">ctx</span><span class="z-punctuation z-separator z-type z-rust">:</span> ThreadContext,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">  <span class="z-variable z-other z-member z-rust">state</span><span class="z-punctuation z-separator z-type z-rust">:</span> State,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Debug<span class="z-punctuation z-separator z-rust">,</span> Default</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">repr</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">C</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">ThreadContext</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">  <span class="z-variable z-other z-member z-rust">rsp</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u64</span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">  <span class="z-variable z-other z-member z-rust">r15</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">u64</span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">  <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ç¾åœ¨ã®<code>ThreadContext</code>ã¨å®Ÿè¡Œã‚’åˆ‡ã‚Šæ›¿ãˆãŸã„<code>ThreadContext</code>ã‚’å¼•æ•°(<code>rdi</code>,<code>rsi</code>)ã§ã‚‚ã‚‰ã£ã¦ã€åˆ‡ã‚Šæ›¿ãˆã‚‹assemblyã‚’<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-keyword z-other z-rust">extern</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>C<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">switch</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">asm!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>mov [rdi + 0x00], rsp<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>mov [rdi + 0x30], rbp<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>mov rsp, [rsi + 0x00]<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>mov rbp, [rsi + 0x30]<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>ret<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-support z-function z-rust">options</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>noreturn</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">RuntimeãŒå‘¼ã³å‡ºã™ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">yield</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">  <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">  <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">      <span class="z-storage z-type z-rust">let</span> old<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-modifier z-rust">*mut</span> ThreadContext <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>threads<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>old_pos<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>ctx<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">      <span class="z-storage z-type z-rust">let</span> new<span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">*const</span> ThreadContext <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>threads<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>pos<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>ctx<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">      <span class="z-support z-macro z-rust">asm!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>call switch<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-rust">in</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>rdi<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> old<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-rust">in</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>rsi<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> new<span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-function z-rust">clobber_abi</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>C<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">  </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">  <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ã“ã®èª¬æ˜ã‚’ã—ãªãŒã‚‰ã€ISAã§ã‚ã£ãŸã‚Šã€calling conventionã€<code>asm!</code> macroã‚’è§£èª¬ã—ã¦ãã‚Œã¾ã™ã€‚<h2 id=chapter-6-futures-in-rust><a aria-label="Anchor link for: chapter-6-futures-in-rust" class=zola-anchor href=#chapter-6-futures-in-rust>Chapter 6: Futures in Rust</a></h2><p>6ç« ã¯Rustã®Futureã®æ¦‚è¦ã«ã¤ã„ã¦ã®çŸ­ã„ç« ã§ã™ã€‚<br> Rustã§ã¯builtinã®runtimeã¯æä¾›ã•ã‚Œã¦ã„ãªã„ã§ã‚ã£ãŸã‚Šã€stdãŒæä¾›ã—ã¦ã„ã‚‹ã‚‚ã®(Future trait, Waker type)ã®èª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚<br> ã¾ãŸã€async runtimeã®mental modelã¨ã—ã¦ã€Reactor, Executor,Futureã®é–¢ä¿‚ãŒè§£èª¬ã•ã‚Œã¾ã™ã€‚<h2 id=chapter-7-coroutines-and-async-await><a aria-label="Anchor link for: chapter-7-coroutines-and-async-await" class=zola-anchor href=#chapter-7-coroutines-and-async-await>Chapter 7: Coroutines and async/await</a></h2><p>Green threadã¯taskã‚’åœæ­¢/å†é–‹ã•ã›ã‚‹ãŸã‚ã®æƒ…å ±ã‚’stackã«ä¿æŒã§ãã‚‹ãŒã€stackless coroutine(Future)ã¯åœæ­¢/å†é–‹ã®ãŸã‚ã®æƒ…å ±ã‚’stateã”ã¨ã«ä¿æŒã™ã‚‹state machineã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã€‚<br> ãŸã ã€ã“ã®stateã‚’ç›´æ¥æ›¸ãã‚ˆã†ãªã“ã¨ã¯ã›ãšã«ã€<code>.await</code>ã‚’æ›¸ããŸã³ã«ãã“ãŒã€åœæ­¢/å†é–‹ã®ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚Šã€stateãŒå®šç¾©ã•ã‚Œã‚‹ã€‚<br> ã¨ã„ã†ã‚ˆã†ãªã€async/awaitã¯å†…éƒ¨çš„ã«ã¯Stateã«ãªã£ã¦ã„ã‚‹ã¨ã„ã†ã‚ˆã†ãªèª¬æ˜ã¯rustã®futureã®èª¬æ˜ã§ã‚ˆãã¿ã‹ã‘ã‚‹ã¨æ€ã„ã¾ã™ã€‚æœ¬æ›¸ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã¨ã“ã‚ã¯ã€async/awaitã‚’æ›¸ã„ã¦ã—ã¾ã†ã¨ã“ã®å¤‰æ›å‡¦ç†ãŒrustã®compilerå´ã§è¡Œã‚ã‚Œã¦ã—ã¾ã†ã®ã§ã€ç‹¬è‡ªã«coroutine/waitã‚’å®šç¾©ã—ã¦ã€stateã¸ã®å¤‰æ›å‡¦ç†ã‚’è‡ªä½œã®<code>corofy</code>ã§è¡Œã†ç‚¹ã§ã™ã€‚<p>å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªcodeã‚’<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust">coroutine <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">async_main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> txt <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Http<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-support z-function z-rust">get_path</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">0</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>wait<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{txt}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> txt <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Http<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-support z-function z-rust">get_path</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>wait<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><code>corofy</code>ã§å¤‰æ›ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªcodeã‚’å‡ºåŠ›ã—ã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">async_main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> impl <span class="z-meta z-generic z-rust">Future<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>Output=<span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-path z-rust">Coroutine0<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">        
</span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-storage z-type z-enum z-rust">enum</span> <span class="z-entity z-name z-enum z-rust">State0</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    Start<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    Wait1<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Box</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>dyn <span class="z-meta z-generic z-rust">Future<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>Output = <span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    Wait2<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Box</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>dyn <span class="z-meta z-generic z-rust">Future<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>Output = <span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust">    Resolved<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-enum z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Coroutine0</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">state</span><span class="z-punctuation z-separator z-type z-rust">:</span> State0,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Coroutine0</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">new</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">Self</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">Self</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> state<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">State0<span class="z-punctuation z-accessor z-rust">::</span></span>Start </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Future <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">Coroutine0</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Output</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">poll</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-generic z-rust">PollState<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Output<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">loop</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">match</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>state <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-meta z-path z-rust">State0<span class="z-punctuation z-accessor z-rust">::</span></span>Start <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">              <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-meta z-path z-rust">State0<span class="z-punctuation z-accessor z-rust">::</span></span>Wait1<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-storage z-modifier z-rust">ref</span> <span class="z-storage z-modifier z-rust">mut</span> f1</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">              <span class="z-keyword z-operator z-arithmetic z-rust">/</span> <span class="z-keyword z-operator z-range z-rust">...</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span></code></pre><p>å‹•ãå…·ä½“ä¾‹ãŒã‚ã‚‹ã®ã§ã€<code>.await</code>ã‚’æ›¸ããŸã³ã«stateãŒå®šç¾©ã•ã‚Œã‚‹ã¨ã„ã†ã®ãŒã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã„ã¾ã—ãŸã€‚ã¾ãŸã€å¤‰æ›å‡¦ç†ã‚’è‡ªä½œã™ã‚‹ã“ã¨ã§å¾Œè¿°ã®self referenceã®å•é¡Œã®ã‚ã‹ã‚Šã‚„ã™ã•ã«ã‚‚ç¹‹ãŒã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã—ãŸã€‚<h2 id=chapter-8-runtimes-wakers-and-the-reactor-executor-pattern><a aria-label="Anchor link for: chapter-8-runtimes-wakers-and-the-reactor-executor-pattern" class=zola-anchor href=#chapter-8-runtimes-wakers-and-the-reactor-executor-pattern>Chapter 8: Runtimes, Wakers, And The Reactor-Executor Pattern</a></h2><p>7ç« ã§ã¯ã€ä½œã£ã¦ã„ãªã‹ã£ãŸRuntimeã‚’ä½œã‚Šã¾ã™ã€‚reactorã«ã¯mioã‚’ä½¿ã„ã¾ã™ã€‚ è‡ªåˆ†ã¯runtimeã¯futureã‚’pollã—ã¦ãã‚Œã¦ã„ã‚‹ãã‚‰ã„ã®ç†è§£ã§ã€reactor(mio)ã‚’ã©ã®ã‚ˆã†ã«åˆ©ç”¨ã™ã‚‹ã®ã‹ãŒãƒ”ãƒ³ã¨ãã¦ã„ãªã‹ã£ãŸã®ã§æœ¬ç« ã¯ã¨ã¦ã‚‚ã‚ã‚ŠãŒãŸã‹ã£ãŸã§ã™ã€‚æœ€åˆã¯executorãŒç›´æ¥reactorã«ä¾å­˜ã™ã‚‹å½¢ã§å®Ÿè£…ã—ãŸã®ã¡ã€executorã¨reactorã‚’ç–çµã«ã™ã‚‹ãŸã‚ã«ã€<code>Waker</code>ã‚’åˆ©ç”¨ã—ãŸå½¢ã«ã—ã¦ã„ãã¨ã„ã†æµã‚Œãªã®ã‚‚ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚<br> <code>Waker</code>ã®wakeå‡¦ç†ã¯<code>Thread::unpark()</code>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚threadã®parké–¢é€£ã¯<a href=https://blog.ymgyt.io/entry/rust-atomics-and-locks-ja/>Rustã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œã¨ãƒ­ãƒƒã‚¯</a>ã§è©³ã—ãèª¬æ˜ã—ã¦ãã‚Œã¦ã„ãŸã®ã§ã€ã™ã‚“ãªã‚Šç†è§£ã§ããŸã®ãŒã†ã‚Œã—ã‹ã£ãŸã§ã™ã€‚<br> (ãªãŠã€æœ¬ç« ã®ä¾‹ã§ã¯work stealã¾ã§ã¯å®Ÿè£…ã•ã‚Œã¾ã›ã‚“ã€‚)<h2 id=chapter-9-coroutines-self-referential-struct-and-pinning><a aria-label="Anchor link for: chapter-9-coroutines-self-referential-struct-and-pinning" class=zola-anchor href=#chapter-9-coroutines-self-referential-struct-and-pinning>Chapter 9: Coroutines, Self-Referential Struct, And Pinning</a></h2><p>Rustã®Futureã¨ã„ãˆã°ã€Pinã¿ãŸã„ãªã¨ã“ã‚ãŒã‚ã‚Šã¾ã™ãŒã€å®Ÿã¯ã“ã‚Œã¾ã§ã®ä¾‹ã§ã¯å·§å¦™ã«Pinã®å•é¡Œã‚’é¿ã‘ã¦ã„ã¾ã—ãŸã€‚<br> æœ¬ç« ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«waitã‚’ã¾ãŸã„ã§é–¢æ•°å†…ã®å¤‰æ•°(<code>counter</code>)ã®å‚ç…§ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ç”Ÿæˆã•ã‚Œã‚‹stateã«localå¤‰æ•°ã‚’ä¿æŒã§ãã‚‹ã‚ˆã†ãªå¯¾å¿œã‚’è¿½åŠ ã—ã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust">coroutine <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">async_main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> counter <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â <span class="z-storage z-type z-rust">let</span> txt <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">http<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">Http<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/600/HelloAsyncAwait<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>wait<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â counter <span class="z-keyword z-operator z-assignment z-rust">+=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â <span class="z-storage z-type z-rust">let</span> txt <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">http<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">Http<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/400/HelloAsyncAwait<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>wait<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â counter <span class="z-keyword z-operator z-assignment z-rust">+=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ã“ã‚Œã«ã‚ˆã£ã¦ã€async(coroutine)å†…ã§æ›¸ã„ãŸlocalå¤‰æ•°ãŒã©ã®ã‚ˆã†ã«å¤‰æ›ã•ã‚Œã‚‹ã‹ã‚’ç†è§£ã—ãŸã‚ã¨ã«æœ¬å‘½ã®self referenceã®å•é¡ŒãŒç´¹ä»‹ã•ã‚Œã¾ã™<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust">coroutine <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">async_main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> buffer <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-character z-escape z-rust">\n</span>BUFFER:<span class="z-constant z-character z-escape z-rust">\n</span>----<span class="z-constant z-character z-escape z-rust">\n</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â <span class="z-storage z-type z-rust">let</span> writer <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> buffer<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â <span class="z-storage z-type z-rust">let</span> txt <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">http<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">Http<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/600/HelloAsyncAwait<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>wait<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â <span class="z-storage z-type z-rust">let</span> txt <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">http<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">Http<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/400/HelloAsyncAwait<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>wait<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">Â Â Â Â <span class="z-support z-macro z-rust">writeln!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust">writer,</span><span class="z-meta z-group z-rust"> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{txt}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ä¸Šè¨˜ã®ã‚ˆã†ã«ã€<code>&mut buffer</code>ã®ã‚ˆã†ãªå‚ç…§ã‚’localå¤‰æ•°ã¨ã™ã‚‹ã¨<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Default</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Stack0</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">buffer</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">writer</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-rust">*mut</span> <span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Coroutine0</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">stack</span><span class="z-punctuation z-separator z-type z-rust">:</span> Stack0,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">state</span><span class="z-punctuation z-separator z-type z-rust">:</span> State0,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">_pin</span><span class="z-punctuation z-separator z-type z-rust">:</span> PhantomPinned,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ç”Ÿæˆã•ã‚Œã‚‹state(<code>Coroutine0</code>)ã§è‡ªèº«ã®fieldã¸ã®å‚ç…§(ä¿æŒã§ããªã„ã®ã§pointer)ã‚’ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã“ã®structã‚’moveã™ã‚‹ã¨pointerã®å‚ç…§ãŒå£Šã‚Œã¦ã—ã¾ã†ã¨ã¤ãªãŒã‚Šã¾ã™ã€‚<br> ã“ã“ã‹ã‚‰ã€<code>Pin</code>ã‚„<code>Unpin</code>ã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<code>Pin</code>ã®èª¬æ˜ã¯å›³ãŒè±Šå¯Œã§ã€localå¤‰æ•°ã®å‚ç…§ã‚’struct fieldã«å¤‰æ›ã™ã‚‹å‡¦ç†ã‚’å®Ÿéš›ã«å‹•ãã‚³ãƒ¼ãƒ‰ã«ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã€å…·ä½“çš„ã§ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚<h2 id=chapter-10-creating-your-own-runtime><a aria-label="Anchor link for: chapter-10-creating-your-own-runtime" class=zola-anchor href=#chapter-10-creating-your-own-runtime>Chapter 10: Creating Your Own Runtime</a></h2><p>ã“ã‚Œã¾ã§åˆ©ç”¨ã—ã¦ããŸè‡ªä½œã®Wakerã§ã‚ã£ãŸã‚ŠFuture traitã§ã‚ã£ãŸã‚Šã‚’rustã®stdã®ã‚‚ã®ã«ã—ã¦your own runtimeã‚’å®Œæˆã•ã›ã¾ã™ã€‚<pre class="language-toml z-code" data-lang=toml><code class=language-toml data-lang=toml><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">dependencies</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">mio</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-inline-table z-begin z-toml">{</span> <span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">version</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>0.8<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span><span class="z-punctuation z-separator z-inline-table z-toml">,</span> <span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">features</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-punctuation z-definition z-array z-begin z-toml">[</span><span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>net<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span><span class="z-punctuation z-separator z-array z-toml">,</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>os-poll<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span><span class="z-punctuation z-definition z-array z-end z-toml">]</span> <span class="z-punctuation z-definition z-inline-table z-end z-toml">}</span>
</span></code></pre><p>mioã ã‘ã®ä¾å­˜ã§ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãŒå‹•ãã‚ˆã†ã«ãªã‚Šã¾ã™!<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> executor <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">runtime<span class="z-punctuation z-accessor z-rust">::</span></span>init<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    executor<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">block_on</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-function z-rust">async_main</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">async <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">async_main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Program starting<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> txt <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Http<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/600/HelloAsyncAwait<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{txt}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> txt <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Http<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/400/HelloAsyncAwait<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{txt}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ç¾çŠ¶ã®Rustã®éåŒæœŸã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã®èª²é¡Œã®èª¬æ˜ã‚‚ã‚ã‚Šã¾ã™ã€‚ tokioã§async_stdã®é•ã„ã¨ã—ã¦reactorã®æ˜ç¤ºçš„ãªèµ·å‹•ã‚’è¦æ±‚ã™ã‚‹ã‹ã©ã†ã‹ã§ã‚ã£ãŸã‚Šã€Ascyn dropã«ã¤ã„ã¦ãŒè§£èª¬ã•ã‚Œã¾ã™ã€‚</div></article></main><footer class=blog-footer><p>Â© 2024 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>