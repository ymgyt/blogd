<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[];gtag(`js`,new Date());gtag(`config`,`G-GTB0KMLN90`)</script><title>ğŸ”­ tracingã‹ã‚‰Attributesã‚’ä»˜ä¸ã—ã¦metricsã‚’å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«tracing-opentelemetryã«PRã‚’é€ã£ãŸ | Happy developing</title><meta content=tracing-opentelemetryã®MetricsLayerã«æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹PRã‚’é€ã£ãŸè©± name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ”­ tracingã‹ã‚‰Attributesã‚’ä»˜ä¸ã—ã¦metricsã‚’å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«tracing-opentelemetryã«PRã‚’é€ã£ãŸ" name=twitter:title><meta content=tracing-opentelemetryã®MetricsLayerã«æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹PRã‚’é€ã£ãŸè©± name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/telescope.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ”­ tracingã‹ã‚‰Attributesã‚’ä»˜ä¸ã—ã¦metricsã‚’å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«tracing-opentelemetryã«PRã‚’é€ã£ãŸ</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2023-08-26<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/opentelemetry/>opentelemetry</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#tl-dr>TL;DR</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#qian-ti>å‰æ</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#prdeshi-zhuang-sitaji-neng-nogai-yao>PRã§å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã®æ¦‚è¦</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#metricslayernoshi-zu-mi>MetricsLayerã®ä»•çµ„ã¿</a> <ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#instrumentsnoshi-zu-mi>Instrumentsã®ä»•çµ„ã¿</a></ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#ji-neng-wozhui-jia-surushang-denowen-ti-dian>æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ä¸Šã§ã®å•é¡Œç‚¹</a> <ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#visitorpatantoxiang-xing-gae-i>Visitorãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ç›¸æ€§ãŒæ‚ªã„</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#eventchu-qi-hua-shi-nipan-ding-suru>EventåˆæœŸåŒ–æ™‚ã«åˆ¤å®šã™ã‚‹</a></ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#per-layer-filtering>Per-Layer Filtering</a> <ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#filtertofiltered>Filterã¨Filtered</a></ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#allocationmobi-ketai>Allocationã‚‚é¿ã‘ãŸã„</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#benchmark>Benchmark</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#flamegraph>Flamegraph</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p>ä»Šã„ã‚‹<a href=https://fraim.co.jp/>FRAIM</a>ã¨ã„ã†ä¼šç¤¾ã§ã¯<a href=https://opentelemetry.io/>OpenTelemetry</a>ã®å°å…¥ã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚<br> Backendã¯Rustã§æ›¸ã‹ã‚Œã¦ãŠã‚Šã€Applicationã‹ã‚‰å‡ºåŠ›ã™ã‚‹Metricsã«é–¢ã—ã¦ã‚‚<a href=https://opentelemetry.io/>OpenTelemetry</a>ã®<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics>Metrics</a>ã‚’åˆ©ç”¨ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚<br> æ—¢ã«<a href=https://github.com/tokio-rs/tracing>tracing</a>ã‚’å°å…¥ã—ã¦ã„ã‚‹ã®ã§ã€<a href=https://github.com/tokio-rs/tracing-opentelemetry>tracing-opentelemetry</a>ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§Applicationã«<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics>Metrics</a>ã‚’çµ„ã¿è¾¼ã‚ãªã„ã‹æ¤œè¨ã—ã¦ã„ã¾ã—ãŸã€‚<br> ãã®éš›ã«å¿…è¦ãªæ©Ÿèƒ½ãŒã‚ã£ãŸã®ã§<a href=https://github.com/tokio-rs/tracing-opentelemetry/pull/43>PR</a>ã‚’<a href=https://github.com/tokio-rs/tracing-opentelemetry>tracing-opentelemetry</a>ã«é€ã£ãŸã¨ã“ã‚ãƒãƒ¼ã‚¸ã—ã¦ã‚‚ã‚‰ãˆã¾ã—ãŸã€‚<br> æœ¬è¨˜äº‹ã§ã¯ãã®éš›ã«è€ƒãˆãŸã“ã¨ã‚„å­¦ã³ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ãã¾ã™ã€‚<h1 id=tl-dr><a aria-label="Anchor link for: tl-dr" class=zola-anchor href=#tl-dr>TL;DR</a></h1><p>Rustã®applicationã§<a href=https://opentelemetry.io/>OpenTelemetry</a>ã®<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics>Metrics</a>ã‚’<a href=https://github.com/tokio-rs/tracing>tracing</a>ã‹ã‚‰å‡ºåŠ›ã™ã‚‹ãŸã‚ã«<a href=https://github.com/tokio-rs/tracing-opentelemetry>tracing-opentelemetry</a>ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã€‚<br> ãã®éš›ã«<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/common#attribute>Attribute</a>ã‚’<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics>Metrics</a>ã«é–¢é€£ã¥ã‘ã‚‹<a href=https://www.cncf.io/blog/2023/08/03/streamlining-observability-the-journey-towards-query-language-standardization/>æ©Ÿèƒ½</a>ãŒå¿…è¦ã ã£ãŸã®ã§ã€<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber>tracing-subscriber</a>ã®<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html#per-layer-filtering>Per-Layer Filtering</a>ã‚’åˆ©ç”¨ã—ã¦<a href=https://github.com/tokio-rs/tracing-opentelemetry/pull/43>å®Ÿè£…</a>ã—ãŸã€‚<h1 id=qian-ti><a aria-label="Anchor link for: qian-ti" class=zola-anchor href=#qian-ti>å‰æ</a></h1><p>ã¾ãšå‰æã¨ã—ã¦<a href=https://github.com/tokio-rs/tracing-opentelemetry>tracing-opentelemetry</a>ã®<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€<a href=https://github.com/tokio-rs/tracing>tracing</a>ã®<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã‚’åˆ©ç”¨ã—ã¦<a href=https://opentelemetry.io/>OpenTelemetry</a>ã®<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics>Metrics</a>ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br> ä¾‹ãˆã°<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> provider <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">MeterProvider<span class="z-punctuation z-accessor z-rust">::</span></span>builder<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">build</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-meta z-path z-rust">tracing_subscriber<span class="z-punctuation z-accessor z-rust">::</span></span>registry<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">with</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">MetricsLayer<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>provider</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">init</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-path z-rust">tracing<span class="z-punctuation z-accessor z-rust">::</span></span>info<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>monotonic_counter<span class="z-punctuation z-accessor z-dot z-rust">.</span>foo <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p>ã¨ã™ã‚‹ã¨ã€<code>foo</code> <a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.24.0/specification/metrics/api.md#counter>Counter</a>ã‚’incrementã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<p><a href=https://github.com/tokio-rs/tracing-opentelemetry>tracing-opentelemetry</a>ã®versionã¯<code>0.20.0</code>ã§ã™ã€‚ ãã®ä»–ã®é–¢é€£crateã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚<pre class="language-toml z-code" data-lang=toml><code class=language-toml data-lang=toml><span class="z-source z-toml"><span class="z-punctuation z-definition z-table z-begin z-toml">[</span><span class="z-meta z-tag z-table z-toml"><span class="z-entity z-name z-table z-toml">dependencies</span></span><span class="z-punctuation z-definition z-table z-end z-toml">]</span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">opentelemetry</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>0.20.0<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">tracing</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>0.1.35<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
</span><span class="z-source z-toml"><span class="z-meta z-tag z-key z-toml"><span class="z-entity z-name z-tag z-toml">tracing-subscriber</span></span> <span class="z-punctuation z-definition z-key-value z-toml">=</span> <span class="z-string z-quoted z-double z-basic z-toml"><span class="z-punctuation z-definition z-string z-begin z-toml">"</span>0.3.0<span class="z-punctuation z-definition z-string z-end z-toml">"</span></span>
</span></code></pre><h1 id=prdeshi-zhuang-sitaji-neng-nogai-yao><a aria-label="Anchor link for: prdeshi-zhuang-sitaji-neng-nogai-yao" class=zola-anchor href=#prdeshi-zhuang-sitaji-neng-nogai-yao>PRã§å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã®æ¦‚è¦</a></h1><p><a href=https://github.com/tokio-rs/tracing>tracing</a>ã‹ã‚‰<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics>Metrics</a>ã‚’å‡ºåŠ›ã™ã‚‹éš›ã«ã€<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/common#attribute>Attribute</a>ã‚’ä»˜ä¸ã§ããªã„ã¨ã„ã£ãŸåˆ¶ç´„ãŒã‚ã‚Šã¾ã—ãŸã€‚ <a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/common#attribute>Attribute</a>ã¨ã¯ã€<a href=https://opentelemetry.io/>OpenTelemetry</a>ã«ãŠã‘ã‚‹key valueã®ãƒšã‚¢ã§ã™ã€‚<p>ä¾‹ãˆã°<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-path z-rust">tracing<span class="z-punctuation z-accessor z-rust">::</span></span>info<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">  monotonic_counter<span class="z-punctuation z-accessor z-dot z-rust">.</span>request_count <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">  http<span class="z-punctuation z-accessor z-dot z-rust">.</span>route <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/foo<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">  http<span class="z-punctuation z-accessor z-dot z-rust">.</span>response<span class="z-punctuation z-accessor z-dot z-rust">.</span>status_code <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">200</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p>ã¨ã—ãŸå ´åˆã«ã€<code>request_count</code> <a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.24.0/specification/metrics/api.md#counter>Counter</a>ã¯å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã™ãŒã€<code>http.route="/foo"</code>ã‚„<code>http.response.sattus_code=200</code>ã¨ã„ã£ãŸæƒ…å ±ã‚’metricsã«ä»˜ä¸ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br> ã“ã®ç‚¹ã«ã¤ã„ã¦ã¯ã€<a href=https://github.com/tokio-rs/tracing-opentelemetry/issues/32>feature requestã®issue</a>ã‚‚ä¸ŠãŒã£ã¦ãŠã‚Šã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã«<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã®key valueã‚’metricsã«ç´ä»˜ã‘ã‚‹æ©Ÿèƒ½ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<br> ã“ã®æ©Ÿèƒ½ã«ã¤ã„ã¦ã¯è‡ªåˆ†ã‚‚å¿…è¦ã ã£ãŸã®ã§ã€ã‚„ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚<h1 id=metricslayernoshi-zu-mi><a aria-label="Anchor link for: metricslayernoshi-zu-mi" class=zola-anchor href=#metricslayernoshi-zu-mi><a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã®ä»•çµ„ã¿</a></h1><p>ã¾ãš<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã¿ã¦ã„ãã¾ã™ã€‚<br> <a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html><code>tracing_subscriber::layer::Layer</code></a> traitã‚’å®Ÿè£…ã—ã¦ã€tracing-subscriberã¨composeã™ã‚‹ã“ã¨ã§ã€Userã¯<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã®å„ç¨®lifecycleæ™‚ã«ä»»æ„ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br> ä¾‹ãˆã°ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html#method.on_event><code>on_event()</code></a>ã¯<code>tracing::info!()</code>ç­‰ã§<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ãŒä½œæˆã•ã‚ŒãŸéš›ã«å‘¼ã°ã‚Œã¾ã™ã€‚ tracing/tracing-subscriberã®è©³ç´°ãªä»•çµ„ã¿ã«ã¤ã„ã¦ã¯ä»¥å‰<a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/>ãƒ–ãƒ­ã‚°</a>ã«æ›¸ã„ãŸã®ã§ã‚ˆã‘ã‚Œã°èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚<br> <a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã¯Spanã‚’å‡¦ç†ã—ãªã„ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html#method.on_event><code>on_event()</code></a>ã®ã¿ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> <span class="z-meta z-generic z-rust">Layer<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">MetricsLayer</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"></span><span class="z-meta z-impl z-rust"><span class="z-keyword z-other z-rust">where</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust">    S<span class="z-punctuation z-separator z-rust">:</span> Subscriber + <span class="z-keyword z-other z-rust">for</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'span</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-meta z-generic z-rust">LookupSpan<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'span</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"></span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">on_event</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">event</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-meta z-path z-rust">tracing<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust">Event<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>, <span class="z-variable z-parameter z-rust">_ctx</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Context<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span>, S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> metric_visitor <span class="z-keyword z-operator z-assignment z-rust">=</span> MetricVisitor <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            instruments<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>instruments<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            meter<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>meter<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        event<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">record</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> metric_visitor</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L346>source</a><br> <code>S: Subscriber + for<'span> LookupSpan<'span></code>ã¨ã—ã¦<code>Layer&LTS></code>ã§Layerã«æ¸¡ã—ã¦ã„ã‚‹<code>S</code>ã¯LayerãŒtracing_subscriberã®<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/registry/struct.Registry.html><code>Registry</code></a>ã«composeã•ã‚Œã‚‹ã“ã¨ã‚’è¡¨ç¾ã—ã¦ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã£ã¦Eventå‡¦ç†æ™‚ã«ä»Šã„ã‚‹Spanã®æƒ…å ±ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚ãŒã€ä»Šå›ã¯ç‰¹ã«åˆ©ç”¨ã—ãªã„ã®ã§æ°—ã«ã—ãªãã¦å¤§ä¸ˆå¤«ã§ã™ã€‚<br> <a href=https://github.com/tokio-rs/tracing>tracing</a>ã¯<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã«æ ¼ç´ã•ã‚ŒãŸ<a href=https://docs.rs/tracing/0.1.37/tracing/field/struct.Field.html><code>Field</code></a>ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ‰‹æ®µã¨ã—ã¦<a href=https://docs.rs/tracing/0.1.37/tracing/field/trait.Visit.html><code>Visit</code></a> traitã‚’ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚<br> ã“ã®ä»•çµ„ã¿ã«ã‚ˆã‚Šã€<code>tracing::info!(key = "foo")</code>ã®ã‚ˆã†ã«strå‹ã®fieldã‚’ä½¿ã†ã¨ã€<a href=https://github.com/tokio-rs/tracing>tracing</a>å´ã§ã€<code>Visit::record_str()</code>ã‚’å‘¼ã‚“ã§ãã‚Œã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> Visit <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">MetricVisitor</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">record_debug</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">_field</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span>Field, <span class="z-variable z-parameter z-rust">_value</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span>dyn <span class="z-meta z-path z-rust">fmt<span class="z-punctuation z-accessor z-rust">::</span></span>Debug</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Do nothing
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">record_u64</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">field</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span>Field, <span class="z-variable z-parameter z-rust">value</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">u64</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">      <span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> ... <span class="z-punctuation z-definition z-comment z-rust">*/</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">record_f64</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">field</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span>Field, <span class="z-variable z-parameter z-rust">value</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">f64</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">      <span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> ... <span class="z-punctuation z-definition z-comment z-rust">*/</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">record_i64</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">field</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span>Field, <span class="z-variable z-parameter z-rust">value</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i64</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">      <span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> ...<span class="z-punctuation z-definition z-comment z-rust">*/</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L136>source</a><p><code>MetricVisitor</code>ã§ã‚‚ã“ã®ã‚ˆã†ã«<code>Visit</code>ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> <a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics>Metrics</a>ã¯æ•°å€¤ãªã®ã§ã€<code>record_bool()</code>ã‚„<code>record_str()</code>ã¯å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚‚ã‚ã‹ã‚Šã¾ã™ã€‚<br> ã•ã‚‰ã«å‡¦ç†ã‚’è¿½ã£ã¦ã„ãã¾ã™ã€‚ä¾‹ã¨ã—ã¦ã€<code>record_i64()</code>ã‚’ã¿ã¦ã¿ã‚‹ã¨<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">METRIC_PREFIX_MONOTONIC_COUNTER</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>monotonic_counter.<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">METRIC_PREFIX_COUNTER</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>counter.<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">METRIC_PREFIX_HISTOGRAM</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>histogram.<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> <span class="z-meta z-generic z-rust">Layer<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">MetricsLayer</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"></span><span class="z-meta z-impl z-rust"><span class="z-keyword z-other z-rust">where</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust">    S<span class="z-punctuation z-separator z-rust">:</span> Subscriber + <span class="z-keyword z-other z-rust">for</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'span</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-meta z-generic z-rust">LookupSpan<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'span</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"></span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">record_i64</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">field</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span>Field, <span class="z-variable z-parameter z-rust">value</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i64</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">if</span> <span class="z-storage z-type z-rust">let</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>metric_name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> field<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">strip_prefix</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-other z-rust">METRIC_PREFIX_MONOTONIC_COUNTER</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>instruments<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">update_metric</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>meter<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                <span class="z-meta z-path z-rust">InstrumentType<span class="z-punctuation z-accessor z-rust">::</span></span>CounterU64<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>value <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">u64</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                metric_name<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">            </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-keyword z-control z-rust">if</span> <span class="z-storage z-type z-rust">let</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>metric_name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> field<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">strip_prefix</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-other z-rust">METRIC_PREFIX_COUNTER</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">          <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>instruments<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">update_metric</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> ... <span class="z-punctuation z-definition z-comment z-rust">*/</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-keyword z-control z-rust">if</span> <span class="z-storage z-type z-rust">let</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>metric_name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> field<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">strip_prefix</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-other z-rust">METRIC_PREFIX_HISTOGRAM</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">          <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>instruments<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">update_metric</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> ... <span class="z-punctuation z-definition z-comment z-rust">*/</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L194C4-L194C4>source</a><p>ã¨ãªã£ã¦ãŠã‚Šã€fieldåã«<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ãŒå‡¦ç†ã®å¯¾è±¡ã¨ã™ã‚‹prefix(<code>monotonic_counter,counter,histogram</code>)ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã€<code>self.instruments.update_metric()</code>ã§metricsã®å‡¦ç†ã‚’å®Ÿæ–½ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<h2 id=instrumentsnoshi-zu-mi><a aria-label="Anchor link for: instrumentsnoshi-zu-mi" class=zola-anchor href=#instrumentsnoshi-zu-mi><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L17><code>Instruments</code></a>ã®ä»•çµ„ã¿</a></h2><p>ã¨ã„ã†ã‚ã‘ã§æ¬¡ã«<a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L17><code>Instruments</code></a>ã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã™ã€‚<a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L17><code>Instruments</code></a>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">opentelemetry<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">metrics<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>Counter<span class="z-punctuation z-separator z-rust">,</span> Histogram<span class="z-punctuation z-separator z-rust">,</span> Meter<span class="z-punctuation z-separator z-rust">,</span> MeterProvider<span class="z-punctuation z-separator z-rust">,</span> UpDownCounter</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">MetricsMap</span><span class="z-keyword z-operator z-comparison z-rust"><</span>T<span class="z-keyword z-operator z-comparison z-rust">></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-generic z-rust">RwLock<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">HashMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span>, T<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Default</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Instruments</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">u64_counter</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">MetricsMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">Counter<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-type z-rust">u64</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">f64_counter</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">MetricsMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">Counter<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-type z-rust">f64</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">i64_up_down_counter</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">MetricsMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">UpDownCounter<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-type z-rust">i64</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">f64_up_down_counter</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">MetricsMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">UpDownCounter<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-type z-rust">f64</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">u64_histogram</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">MetricsMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">Histogram<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-type z-rust">u64</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">i64_histogram</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">MetricsMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">Histogram<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-type z-rust">i64</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">f64_histogram</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">MetricsMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">Histogram<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-type z-rust">f64</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L17>source</a><p><a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics>Metrics</a>ã®ç¨®åˆ¥(<a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.24.0/specification/metrics/api.md#instrument>Instrument</a>)ã”ã¨ã«metricsåã¨metricsã®å®Ÿè£…(<code>Counter</code>ç­‰)ã‚’<code>HashMap</code>ã§ä¿æŒã—ã¦ã„ã¾ã™ã€‚<br> <code>opentelemetry::metrics</code>ã‹ã‚‰åˆ©ç”¨ã—ã¦ã„ã‚‹ã€<code>{Counter, UpDownCounter, Histogram}</code>ã¯metricsã®å®Ÿè£…ã§ã™ã€‚<br> <code>opentelemetry_{api,sdk}</code> crateã§metricsãŒã©ã†å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦ã‚‚æ›¸ããŸã„ã®ã§ã™ãŒã‹ãªã‚Šè¤‡é›‘ãªã®ã§ã€ä»Šå›ã¯ãµã‚Œã¾ã›ã‚“ã€‚<br> (ä»¥ä¸‹ã¯Metricsé–¢é€£ã®å‡¦ç†ã‚’èª­ã‚“ã§ã„ã¦ã€metricsãŒç”Ÿæˆã•ã‚Œã¦ã‹ã‚‰exportã•ã‚Œã‚‹ã¾ã§ã®æµã‚Œã‚’è¿½ã†éš›ã®ãƒ¡ãƒ¢ã§ã™)<p><img alt="metrics pipeline" src=https://storage.googleapis.com/zenn-user-upload/99fd1a21adc4-20230813.png> <em>Metricsã®ç”Ÿæˆã‹ã‚‰exportã¾ã§ã®æµã‚Œ</em><p><img alt="opentelemetry metrics overview" src=https://storage.googleapis.com/zenn-user-upload/2489bfdb2dcc-20230813.png> <em>Metricsé–¢é€£ã®structã®é–¢ä¿‚</em><p><code>Counter</code>ã¯ãƒ¡ãƒ¢ãƒªã«ç¾åœ¨ã®å€¤ã‚’ä¿æŒã—ã¦ã€incrementã—ã¤ã¤ã€å®šæœŸçš„ã«exportã—ã¦ã„ãã ã‘ãªã®ã§ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¨è€ƒãˆã¦ã„ãŸã®ã§ã™ãŒæ€ã£ãŸã‚ˆã‚Šè‰²ã€…ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒé–¢ä¸ã—ã¦ã„ã¾ã—ãŸã€‚<br> ãªã®ã§æœ¬è¨˜äº‹ã§ã¯<code>Counter::add()</code>ã—ãŸã‚‰ã€<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics>Metrics</a>ãŒå‡ºåŠ›ã•ã‚Œã‚‹ãã‚‰ã„ã®ç†è§£ã§ã„ãã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">opentelemetry<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">metrics<span class="z-punctuation z-accessor z-rust">::</span></span>Meter<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">MetricsMap</span><span class="z-keyword z-operator z-comparison z-rust"><</span>T<span class="z-keyword z-operator z-comparison z-rust">></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-generic z-rust">RwLock<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">HashMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span>, T<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Instruments</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">update_metric</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">        <span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>,
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">        <span class="z-variable z-parameter z-rust">meter</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span>Meter,
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">        <span class="z-variable z-parameter z-rust">instrument_type</span><span class="z-punctuation z-separator z-rust">:</span> InstrumentType,
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">        <span class="z-variable z-parameter z-rust">metric_name</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span>,
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">update_or_insert</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>T<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">            <span class="z-variable z-parameter z-rust">map</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-meta z-generic z-rust">MetricsMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>T<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">            <span class="z-variable z-parameter z-rust">name</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span>,
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">            <span class="z-variable z-parameter z-rust">insert</span><span class="z-punctuation z-separator z-rust">:</span> impl FnOnce<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> -> T,
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">            <span class="z-variable z-parameter z-rust">update</span><span class="z-punctuation z-separator z-rust">:</span> impl FnOnce<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust">&<span class="z-variable z-parameter z-rust">T</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>,
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust">        </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-storage z-type z-rust">let</span> lock <span class="z-keyword z-operator z-assignment z-rust">=</span> map<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">read</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-keyword z-control z-rust">if</span> <span class="z-storage z-type z-rust">let</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>metric</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> lock<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                    <span class="z-support z-function z-rust">update</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>metric</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                    <span class="z-keyword z-control z-rust">return</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> that metric did not already exist, so we have to acquire a write lock to
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> create it.
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> lock <span class="z-keyword z-operator z-assignment z-rust">=</span> map<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">write</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> handle the case where the entry was created while we were waiting to
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> acquire the write lock
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> metric <span class="z-keyword z-operator z-assignment z-rust">=</span> lock<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">entry</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">or_insert_with</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>insert</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-support z-function z-rust">update</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>metric</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">match</span> instrument_type <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-meta z-path z-rust">InstrumentType<span class="z-punctuation z-accessor z-rust">::</span></span>CounterU64<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>value</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-support z-function z-rust">update_or_insert</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                    <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>u64_counter<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                    metric_name<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                    <span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust">meter<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">u64_counter</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>metric_name</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">init</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust">                    <span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">ctr</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust">ctr<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">add</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>value<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-closure z-rust">                </span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> ...<span class="z-punctuation z-definition z-comment z-rust">*/</span></span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L40>source</a><p><a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ãŒmetricsã‚’å‡¦ç†ã™ã‚‹éš›ã«ã‚ˆã°ã‚Œã‚‹<code>self.instruments.update_metric()</code>ã¯ä¸Šè¨˜ã®ã‚ˆã†ãªå‡¦ç†ã¨ãªã£ã¦ã„ã¾ã™ã€‚æ¦‚ã­ä»¥ä¸‹ã®ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<ul><li>æ¯å›<code>RwLock::read()</code>ã«ã‚ˆã‚‹lockãŒç™ºç”Ÿã™ã‚‹<li>åˆå›ã¯<code>Meter</code>ã«ã‚ˆã‚‹Instrument(Counterç­‰)ã®ç”Ÿæˆå‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹<li><code>Counter::add()</code>ã™ã‚‹éš›ã®ç¬¬äºŒå¼•æ•°ã«ã¯ç©ºsliceãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹(ä»Šå›ã®å¤‰æ›´ç‚¹ã«é–¢é€£ã™ã‚‹)</ul><p>ã“ã®å‡¦ç†ã‚’ç¢ºèªã—ãŸã“ã¨ã§ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã®documentã®èª¬æ˜ãŒã‚ˆã‚Šç†è§£ã§ãã¾ã™ã€‚<br> ä¾‹ãˆã°<blockquote><p>No configuration is needed for this Layer, as it's only responsible for pushing data out to the <code>opentelemetry</code> family of crates.</blockquote><p>ã¨ã‚ã‚‹ã‚ˆã†ã«<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã¯ç‰¹ã«å®Ÿè³ªçš„ãªå‡¦ç†ã‚’è¡Œã£ã¦ãŠã‚‰ãš<a href=https://github.com/tokio-rs/tracing-opentelemetry>tracing-opentelemetry</a>ã¨ã„ã†crateåã®é€šã‚Šã€tracingã¨opentelemetryã®ecosystemã‚’ã¤ãªãå½¹å‰²ã®ã¿ã‚’æ‹…ã£ã¦ã„ã¾ã™ã€‚<br> ã¾ãŸ<blockquote><p># Implementation Details <code>MetricsLayer</code> holds a set of maps, with each map corresponding to a type of metric supported by OpenTelemetry. These maps are populated lazily. The first time that a metric is emitted by the instrumentation, a <code>Metric</code> instance will be created and added to the corresponding map. This means that any time a metric is emitted by the instrumentation, one map lookup has to be performed. In the future, this can be improved by associating each <code>Metric</code> instance to its callsite, eliminating the need for any maps.</blockquote><p>(æ„è¨³: <code>MetricLayer</code>ã¯OpenTelemetryã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹metricã®ç¨®åˆ¥ã”ã¨ã«mapã‚’ä¿æŒã—ã¦ã„ã‚‹ã€‚metricsãŒå‡ºåŠ›ã•ã‚Œã‚‹éš›ã«<code>Metric</code>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã€ã“ã‚Œã‚‰ã®mapã«è¿½åŠ ã•ã‚Œã‚‹ã€‚ã“ã‚Œã¯metricsãŒå‡ºåŠ›ã•ã‚Œã‚‹ãŸã³ã«mapã®lookupãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ„å‘³ã™ã‚‹ã€‚å°†æ¥çš„ã«ã¯<code>Metric</code>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’callsiteã«ç´ä»˜ã‘ã‚‹ã“ã¨ã§mapãŒå¿…è¦ãªããªã‚Šæ”¹å–„ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚) ã¨ã„ã†èª¬æ˜ã‚‚ãªã‚‹ã»ã©ã¨ç†è§£ã§ãã¾ã™ã€‚<br> ã¡ãªã¿ã«callsiteã¨ã„ã†ã®ã¯ã€<code>tracing::info!()</code> macroå‘¼ã³å‡ºã—æ™‚ã«staticã§ç”Ÿæˆã•ã‚Œã‚‹macroå‘¼ã³å‡ºã—æ™‚ã®æƒ…å ±ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚<p>ã¨ã„ã†ã‚ã‘ã§ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ãŒmetricsã‚’å‡ºåŠ›ã™ã‚‹æ–¹æ³•ã®æ¦‚è¦ãŒç†è§£ã§ãã¾ã—ãŸã€‚<h1 id=ji-neng-wozhui-jia-surushang-denowen-ti-dian><a aria-label="Anchor link for: ji-neng-wozhui-jia-surushang-denowen-ti-dian" class=zola-anchor href=#ji-neng-wozhui-jia-surushang-denowen-ti-dian>æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ä¸Šã§ã®å•é¡Œç‚¹</a></h1><p>ã¾ãšä»Šå›è¿½åŠ ã—ãŸã„æ©Ÿèƒ½ã‚’æ•´ç†ã—ã¾ã™ã€‚<br> <a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.24.0/specification/metrics/api.md#counter-operations>Counterã«é–¢ã™ã‚‹ä»•æ§˜</a>ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚<blockquote><p>Counter operations Add This API MUST accept the following parameter: * A numeric increment value. * Attributes to associate with the increment value.<br> Users can provide attributes to associate with the increment value, but it is up to their discretion. Therefore, this API MUST be structured to accept a variable number of attributes, including none.</blockquote><p>ã¨ã—ã¦ã€Counterã‚’incrementã™ã‚‹éš›ã«<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/common#attribute>Attributes</a>ã‚’æ¸¡ã›ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã‚’å—ã‘ã¦ã€Rustã®OpenTelemetryã®å®Ÿè£…ã§ã‚‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>T<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">Counter</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>T<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-documentation z-rust"><span class="z-punctuation z-definition z-comment z-rust">///</span> Records an increment to the counter.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">add</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">value</span><span class="z-punctuation z-separator z-rust">:</span> T, <span class="z-variable z-parameter z-rust">attributes</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span>[KeyValue]</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-constant z-numeric z-float z-rust">0.</span><span class="z-support z-function z-rust">add</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>value<span class="z-punctuation z-separator z-rust">,</span> attributes</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><a href=https://github.com/open-telemetry/opentelemetry-rust/blob/dfeac078ff7853e7dc814778524b93470dfa5c9c/opentelemetry-api/src/metrics/instruments/counter.rs#L28>source</a><p>ã®ã‚ˆã†ã«incrementæ™‚ã«attributeã¨ã—ã¦ã€<a href=https://docs.rs/opentelemetry/latest/opentelemetry/struct.KeyValue.html><code>KeyValue</code></a>ã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<br> ã¨ã„ã†ã“ã¨ã§ã€è¿½åŠ ã—ãŸã„æ©Ÿèƒ½ã¯<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã§<a href=https://docs.rs/opentelemetry/latest/opentelemetry/struct.KeyValue.html><code>KeyValue</code></a>ã‚’ä½œã£ã¦ã€<code>Counter:add()</code>æ™‚ã«æ¸¡ã›ã°è‰¯ã•ãã†ã§ã™ã€‚<br> ãã‚“ãªã«é›£ã—ããªã•ãã†ã¨æ€ã„ã€æ•°è¡Œã®å¤‰æ›´ã§ã„ã‘ã‚‹ã®ã§ã¯ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚<h2 id=visitorpatantoxiang-xing-gae-i><a aria-label="Anchor link for: visitorpatantoxiang-xing-gae-i" class=zola-anchor href=#visitorpatantoxiang-xing-gae-i>Visitorãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ç›¸æ€§ãŒæ‚ªã„</a></h2><p>ç€æ‰‹ã—ã¦ã‚ã‹ã£ãŸã“ã¨ã§ã™ãŒã€<code>Counter::add()</code>å‘¼ã³å‡ºã—æ™‚ã«metrics(<code>counter.foo</code>)ä»¥å¤–ã®fieldã‚’<a href=https://docs.rs/opentelemetry/latest/opentelemetry/struct.KeyValue.html><code>KeyValue</code></a>ã«å¤‰æ›ã—ã¦æ¸¡ã™ã¨ã„ã†ã®ã¯Visitorãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ç›¸æ€§ãŒæ‚ªã„ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚<br> ã¨ã„ã†ã®ã‚‚ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãª<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã‚’è€ƒãˆã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-path z-rust">tracing<span class="z-punctuation z-accessor z-rust">::</span></span>info<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>monotonic_counter<span class="z-punctuation z-accessor z-dot z-rust">.</span>foo <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-separator z-rust">,</span> bar <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>baz<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> qux <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">2</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></code></pre><p>ã“ã®<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã‚’å‡¦ç†ã™ã‚‹éš›ã€ã•ãã»ã©ã¿ãŸ<code>MetricVisitor</code>ã¯<code>monotonic_counter.foo</code>ã‚’å‡¦ç†ã™ã‚‹éš›ã¯ã¾ã ã€<code>bar,qux</code> fieldã‚’å‡¦ç†ã—ã¦ã„ãªã„ã®ã§ã€<code>Counter::add()</code>ã‚’å‘¼ã³å‡ºã›ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚<br> ãã®ãŸã‚ã€visitæ™‚ã«å¯¾è±¡ã®fieldãŒå‡¦ç†å¯¾è±¡ãªã‚‰å‡¦ç†ã™ã‚‹ã®ã§ã¯ãªãã€ä¸€åº¦ã€ã™ã¹ã¦ã®fieldã®visitã‚’å®Œäº†ã•ã›ãŸã®ã¡ã«ã€<code>Counter::add()</code>ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ãã†ãªã‚‹ã¨ã€visitæ™‚ã«<code>Vec</code>ç­‰ã«metricsã®æƒ…å ±ã‚„å¤‰æ›ã—ãŸ<a href=https://docs.rs/opentelemetry/latest/opentelemetry/struct.KeyValue.html><code>KeyValue</code></a>ã‚’ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> ã—ã‹ã—ãªãŒã‚‰ã€ãã†ã—ã¦ã—ã¾ã†ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«metricsã‚’å«ã¾ãªã„<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã‚’å‡¦ç†ã™ã‚‹éš›ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-path z-rust">tracing<span class="z-punctuation z-accessor z-rust">::</span></span>info<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">  http<span class="z-punctuation z-accessor z-dot z-rust">.</span>route <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>/foo<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">  http<span class="z-punctuation z-accessor z-dot z-rust">.</span>response<span class="z-punctuation z-accessor z-dot z-rust">.</span>status_code <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">200</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">  <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Handle request<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span>  
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span></code></pre><p><a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã¨ã—ã¦ã¯ã€metricsã‚’å«ã¾ãªã„æ–¹ãŒå¤šã„ã®ãŒè‡ªç„¶ã§ã™ãŒã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã¨ã—ã¦ã¯ã€visitã—ã¦ã„ã‚‹é€”ä¸­ã§ã¯ãã®<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã«metricsãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã€<code>Vec</code>ã®ç¢ºä¿ã‚„pushç­‰ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> (ã¾ãšvisitã—ãŸã®ã¡ã€metricsãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚‚ã†ä¸€åº¦visitã™ã‚‹æ–¹æ³•ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ãŒéåŠ¹ç‡)<h2 id=eventchu-qi-hua-shi-nipan-ding-suru><a aria-label="Anchor link for: eventchu-qi-hua-shi-nipan-ding-suru" class=zola-anchor href=#eventchu-qi-hua-shi-nipan-ding-suru><a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>åˆæœŸåŒ–æ™‚ã«åˆ¤å®šã™ã‚‹</a></h2><p>å•é¡Œã¨ã—ã¦ã¯ã€ã‚ã‚‹Layerã¯ç‰¹å®šã®<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã«ã®ã¿é–¢å¿ƒãŒã‚ã‚Šã€ãã®åˆ¤å®šã‚’<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>å‡¦ç†æ™‚ã§ã¯ãªãã€ã„ãšã‚Œã‹ã®åˆæœŸåŒ–æ™‚ã«ä¸€åº¦ã ã‘è¡Œã„ãŸã„ã¨ã„ã†çŠ¶æ³ã§ã™ã€‚<br> ã“ã‚Œã¯ç‰¹å®šã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹Layerã¨ã—ã¦ã¯ä¸€èˆ¬ã«å¿…è¦ã«ãªã‚Šãã†ãªã®ã§ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html><code>Layer</code></a> traitã«ãã†ã„ã£ãŸmethodãŒãªã„ã‹ã¿ã¦ã„ãŸã¨ã“ã‚ã€ãã‚Œã‚‰ã—ãã‚‚ã®ãŒã‚ã‚Šã¾ã—ãŸã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">register_callsite</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">metadata</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-meta z-generic z-rust">Metadata<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> Interest
</span></span></span></code></pre><p><a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html#method.register_callsite>docs</a><blockquote><p>Registers a new callsite with this layer, returning whether or not the layer is interested in being notified about the callsite, similarly to Subscriber::register_callsite.</blockquote><p>ã¨ã‚ã‚‹ã®ã§ã€<code>tracing::info!()</code>ã‚’å‘¼ã³å‡ºã™ã¨ä¸€åº¦ã ã‘ã€<code>MetricsLayer::register_callsite()</code>ã‚’å‘¼ã‚“ã§ãã‚Œãã†ã§ã™ã€‚<br> ã¾ãŸ<a href=https://docs.rs/tracing-core/0.1.30/tracing_core/metadata/struct.Metadata.html#method.callsite><code>Metadata::callsite() -> Identirifer</code></a>ã‹ã‚‰ã€<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã®è­˜åˆ¥å­ã‚‚å–å¾—ã§ãã‚‹ã®ã§<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ãŒmetricsã‹ã©ã†ã‹äº‹å‰ã«ä¸€åº¦ã ã‘åˆ¤å®šã—ãŸã„ã¨ã„ã†æ©Ÿèƒ½ã¯å®Ÿç¾ã§ããã†ã«æ€ã‚ã‚Œã¾ã—ãŸã€‚<br> ã‚‚ã£ã¨ã‚‚ã€æ³¨æ„ãŒå¿…è¦ãªã®ã¯<blockquote><p>Note: This method (and Layer::enabled) determine whether a span or event is globally enabled, not whether the individual layer will be notified about that span or event. This is intended to be used by layers that implement filtering for the entire stack. Layers which do not wish to be notified about certain spans or events but do not wish to globally disable them should ignore those spans or events in their on_event, on_enter, on_exit, and other notification methods.</blockquote><p>(æ„è¨³: ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯spanã‚„eventãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã§æœ‰åŠ¹ã‹ã‚’åˆ¤å®šã™ã‚‹ã‚‚ã®ã§ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼å˜ä½ã§spanã‚„eventã®é€šçŸ¥ã‚’åˆ¶å¾¡ã™ã‚‹ã‚‚ã®ã§ã¯ãªã„ã€‚ã“ã‚Œã¯ã‚¹ã‚¿ãƒƒã‚¯å…¨ä½“ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ„å›³ã—ãŸã‚‚ã®ã€‚ç‰¹å®šã®spanã‚„eventã‚’å‡¦ç†ã®å¯¾è±¡ã¨ã¯ã—ãªã„ãŒã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ç„¡åŠ¹ã«ã—ãŸããªã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å˜ã«on_eventã§ãã‚Œã‚‰ã‚’ç„¡è¦–ã™ã‚Œã°ã‚ˆã„ã€‚)<p>ã¨ã‚ã‚‹ã‚ˆã†ã«ã€<code>register_callsite()</code>ã‚’åˆ©ç”¨ã—ã¦ã‚‚ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã§metricsä»¥å¤–ã®eventã§<code>on_event()</code>ãŒå‘¼ã°ã‚Œãªããªã‚‹ã‚ã‘ã§ã¯ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚(ãã®ã‚ˆã†ãªä»•çµ„ã¿ã¯åˆ¥ã§ã‚ã‚Šã€ã®ã¡ã»ã©è¨€åŠã—ã¾ã™ã€‚) ã“ã®ä»•çµ„ã¿ã¯<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã‚„<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Span.html><code>Span</code></a>ã‚’ç‰¹å®šã®Levelã§filterã™ã‚‹(DEBUGã‚’ç„¡è¦–ã™ã‚‹ç­‰) <a href=https://docs.rs/tracing-subscriber/latest/tracing_subscriber/filter/struct.LevelFilter.html><code>LevelFilter</code></a>å‘ã‘ã§ã‚ã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚ ã¨ã„ã†ã“ã¨ã§ã€ã‚ã‚‹<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ãŒmetricsã‚’å«ã‚“ã§ãŠã‚Šå‡¦ç†å¯¾è±¡ã‹ã©ã†ã‹ã¯è‡ªå‰ã§ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<p>ã“ã†ã—ãŸèƒŒæ™¯ã‹ã‚‰ã€æœ€åˆã®PRã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€callsiteã”ã¨ã®åˆ¤å®šçµæœã‚’<code>RwLock</code>ã§ä¿æŒã™ã‚‹<a href=https://github.com/tokio-rs/tracing-opentelemetry/pull/43/commits/c0357cb7726548f4bb822ce2b433e7c96c75e5e2>å®Ÿè£…</a>ã‚’è¡Œã„ã¾ã—ãŸã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">tracing<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">callsite<span class="z-punctuation z-accessor z-rust">::</span></span>Identifier<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Callsites</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">callsites</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">RwLock<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">HashMap<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>Identifier, CallsiteInfo<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Default</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">CallsiteInfo</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">has_metrics_fields</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">bool</span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust"><span class="z-entity z-name z-impl z-rust">Callsites</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">new</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">Self</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        Callsites <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            callsites<span class="z-punctuation z-separator z-rust">:</span> <span class="z-support z-type z-rust">Default</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>default<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">register_metrics_callsite</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">callsite</span><span class="z-punctuation z-separator z-rust">:</span> Identifier, <span class="z-variable z-parameter z-rust">info</span><span class="z-punctuation z-separator z-rust">:</span> CallsiteInfo</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>callsites<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">write</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">insert</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>callsite<span class="z-punctuation z-separator z-rust">,</span> info</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">has_metrics_field</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">callsite</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span>Identifier</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">bool</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>callsites
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">read</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>callsite</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">map</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">info</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust">info<span class="z-punctuation z-accessor z-dot z-rust">.</span>has_metrics_fields</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">unwrap_or</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-language z-rust">false</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> <span class="z-meta z-generic z-rust">Layer<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">MetricsLayer</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"></span><span class="z-meta z-impl z-rust"><span class="z-keyword z-other z-rust">where</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust">    S<span class="z-punctuation z-separator z-rust">:</span> Subscriber + <span class="z-keyword z-other z-rust">for</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'span</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-meta z-generic z-rust">LookupSpan<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'span</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"></span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">     <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">register_callsite</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">metadata</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-meta z-path z-rust">tracing<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust">Metadata<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> Interest</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">if</span> metadata<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">is_event</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-logical z-rust">&&</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">has_metrics_fields</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>metadata<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">fields</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>callsites<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">register_metrics_callsite</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                metadata<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">callsite</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                CallsiteInfo <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">                    has_metrics_fields<span class="z-punctuation z-separator z-rust">:</span> <span class="z-constant z-language z-rust">true</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">                </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">            </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-meta z-path z-rust">Interest<span class="z-punctuation z-accessor z-rust">::</span></span>always<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">on_event</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">event</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-meta z-path z-rust">tracing<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust">Event<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>, <span class="z-variable z-parameter z-rust">_ctx</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Context<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span>, S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">         <span class="z-keyword z-control z-rust">if</span> <span class="z-variable z-language z-rust">self</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span>callsites
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">has_metrics_field</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span>event<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">metadata</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">callsite</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span><span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> ...<span class="z-punctuation z-definition z-comment z-rust">*/</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>è‡ªåˆ†ã¨ã—ã¦ã‚‚<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>æ¯ã«<code>RwLocl::read()</code>ãŒèµ°ã‚‹å®Ÿè£…ã¯å³ã—ã„ã ã‚ã†ãªã¨æ€ã„ã¤ã¤ã€<a href=https://github.com/tokio-rs/tracing-opentelemetry/pull/43/commits/c0357cb7726548f4bb822ce2b433e7c96c75e5e2#r1284671386>ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>ã‚’ãŠé¡˜ã„ã—ã¾ã—ãŸãŒã€ã‚„ã¯ã‚Šåˆ¥ã®æ–¹æ³•ã‚’è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ <img alt="PR review" src=https://storage.googleapis.com/zenn-user-upload/44ec2fbf187b-20230813.png> <em>jtescherã•ã‚“ã¯tracing-opentelemetryã®maintainer</em><h1 id=per-layer-filtering><a aria-label="Anchor link for: per-layer-filtering" class=zola-anchor href=#per-layer-filtering><a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html#per-layer-filtering>Per-Layer Filtering</a></a></h1><p>ãªã«ã‹è‰¯ã„æ–¹æ³•ãŒãªã„ã‹ã¨æ€ã„<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html><code>Layer</code></a>ã®<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html>doc</a>ã‚’èª­ã‚“ã§ã„ã‚‹ã¨ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html#per-layer-filtering>Per-Layer Filtering</a>ã¨ã„ã†ã‚‚ã®ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚<blockquote><p>Sometimes, it may be desirable for one Layer to record a particular subset of spans and events, while a different subset of spans and events are recorded by other Layers.</blockquote><p>(æ„è¨³: æ™‚ã«ã€ã‚ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ç‰¹å®šã®spanã‚„eventsã®ã¿ã‚’å‡¦ç†ã—ã¤ã¤ã€ä»–ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¯å½±éŸ¿ã‚’ã‚ãŸãˆãŸããªã„å ´åˆãŒã‚ã‚‹)<p>ã¾ã•ã«ã€ä»Šã“ã®çŠ¶æ³ãªã®ã§ã“ã®æ©Ÿèƒ½ä½¿ãˆã‚‹ã®ã§ã¯ã¨æ€ã„ã¾ã—ãŸã€‚<br> ã•ã‚‰ã«ã“ã®æ©Ÿèƒ½ã¯<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber>tracing-subscriber</a>ã®<code>registry</code> featureãŒå¿…è¦ãªã®ã§ã™ãŒ<a href=https://github.com/tokio-rs/tracing-opentelemetry>tracing-opentelemetry</a>ã¯æ—¢ã«ã“ã®featureã«ä¾å­˜ã—ã¦ã„ã‚‹ã®ã§ã€breaking changeã¨ã‚‚ãªã‚‰ãªãã†ã§ã—ãŸã€‚<br> Metricsã‚’å«ã‚€<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a>ã«é™å®šã§ãã‚Œã°ã€<code>on_event()</code>ã®å‡¦ç†é–‹å§‹æ™‚ã«<a href=https://docs.rs/tracing/0.1.37/tracing/field/struct.Field.html><code>Field</code></a>ã«metricsãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã®ã§ã€visitæ™‚ã«ãã‚Œãã‚Œã®å€¤ã‚’ä¿æŒã—ã¦ãŠãã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒã¨ã‚Œã‚‹ã®ã§ã€ã“ã®æ©Ÿèƒ½ã‚’çµ„ã¿è¾¼ã‚“ã§ã¿ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸã€‚<h2 id=filtertofiltered><a aria-label="Anchor link for: filtertofiltered" class=zola-anchor href=#filtertofiltered><a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html><code>Filter</code></a>ã¨<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html><code>Filtered</code></a></a></h2><p>ã¾ãšè€ƒãˆãŸã®ãŒã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã«<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html><code>Filter</code></a> traitã‚’å®Ÿè£…ã™ã‚‹ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚<br> ã—ã‹ã—ãªãŒã‚‰ã€docã‚’èª­ã‚“ã ã‚Šæ‰‹å…ƒã§å‹•ã‹ã—ã¦ã¿ãŸã‚Šã—ã¦ã‚ã‹ã£ãŸã®ã§ã™ãŒã€ã‚ã‚‹<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html><code>Layer</code></a>ã«<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html><code>Filter</code></a>ã‚’å®Ÿè£…ã—ã¦ã€tracing subscriberã«composeã—ã¦ã‚‚æ„å›³ã—ãŸåŠ¹æœã¯å¾—ã‚‰ã‚Œãªã„ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚<br> ã¨ã„ã†ã®ã‚‚ã€tracing subscriberã¸ã®composeã¯å®Ÿè£…çš„ã«ã¯ã€<code>Layered</code>ã¨ã„ã†å‹ã«å¤‰æ›ã•ã‚Œã¦ãã‚Œã‚‰ãŒå…¨ä½“ã¨ã—ã¦ã€tracingã®<code>Subscriber</code> traitã‚’å®Ÿè£…ã™ã‚‹ã¨ã„ã†å½¢ã«ãªã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€ãã®å®Ÿè£…ã®ä¸­ã§ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html><code>Filter</code></a> traitã¯ç‰¹ã«å‚ç…§ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br> <a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber>tracing-subscriber</a>ã®APIè¨­è¨ˆçš„ã«ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html><code>Filter</code></a>ã®å®Ÿè£…ã‚’æ¸¡ã—ã¦ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html><code>Filtered</code></a>ã¨ã„ã†<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html><code>Layer</code></a>ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<br> ãã‚ŒãŒãªãœã‹ã¨ã„ã„ã¾ã™ã¨<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-support z-macro z-rust">thread_local!</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-storage z-type z-rust">static</span> <span class="z-constant z-other z-rust">FILTERING</span><span class="z-punctuation z-separator z-rust">:</span> FilterState <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">FilterState<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S, L, F<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> <span class="z-meta z-generic z-rust">Layer<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">Filtered</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>L, F, S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"></span><span class="z-meta z-impl z-rust"><span class="z-keyword z-other z-rust">where</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust">    S<span class="z-punctuation z-separator z-rust">:</span> Subscriber + <span class="z-keyword z-other z-rust">for</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'span</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-meta z-path z-rust">registry<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust">LookupSpan<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'span</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> + <span class="z-storage z-modifier z-lifetime z-rust">'static</span>,
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust">    F<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">layer<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust">Filter<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> + <span class="z-storage z-modifier z-lifetime z-rust">'static</span>,
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust">    L<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Layer<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"></span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">        <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">enabled</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">metadata</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-meta z-generic z-rust">Metadata<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>, <span class="z-variable z-parameter z-rust">cx</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Context<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span>, S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">bool</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> cx <span class="z-keyword z-operator z-assignment z-rust">=</span> cx<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">with_filter</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">id</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-storage z-type z-rust">let</span> enabled <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>filter<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">enabled</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>metadata<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span>cx</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-constant z-other z-rust">FILTERING</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">with</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">filtering</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust">filtering<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">set</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">id</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span> enabled</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-keyword z-control z-rust">if</span> enabled <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> If the filter enabled this metadata, ask the wrapped layer if
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> _it_ wants it --- it might have a global filter.
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>layer<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">enabled</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>metadata<span class="z-punctuation z-separator z-rust">,</span> cx</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Otherwise, return `true`. The _per-layer_ filter disabled this
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> metadata, but returning `false` in `Layer::enabled` will
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> short-circuit and globally disable the span or event. This is
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> *not* what we want for per-layer filters, as other layers may
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> still want this event. Returning `true` here means we'll continue
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> asking the next layer in the stack.
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Once all per-layer filters have been evaluated, the `Registry`
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> at the root of the stack will return `false` from its `enabled`
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> method if *every* per-layer  filter disabled this metadata.
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Otherwise, the individual per-layer filters will skip the next
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> `new_span` or `on_event` call for their layer if *they* disabled
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> the span or event, but it was not globally disabled.
</span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">                <span class="z-constant z-language z-rust">true</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">        <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">on_event</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">event</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-meta z-generic z-rust">Event<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>, <span class="z-variable z-parameter z-rust">cx</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Context<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span>, S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">did_enable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">                <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>layer<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">on_event</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>event<span class="z-punctuation z-separator z-rust">,</span> cx<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">with_filter</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">id</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">}
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>L, F, S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">Filtered</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>L, F, S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">did_enable</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">f</span><span class="z-punctuation z-separator z-rust">:</span> impl FnOnce<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-constant z-other z-rust">FILTERING</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">with</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-variable z-parameter z-rust">filtering</span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust">filtering<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">did_enable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">id</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span> f</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.17/tracing-subscriber/src/filter/layer_filters/mod.rs>source</a><p>ã‚ã¾ã‚Šå®Ÿè£…ã®è©³ç´°ã«ã¯è¸ã¿è¾¼ã¿ã¾ã›ã‚“ãŒã€æ¦‚ã­ä»¥ä¸‹ã®ç‚¹ãŒã‚ã‹ã‚Šã¾ã™ã€‚<ul><li><code>Filtered</code>ã¯<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html><code>Layer</code></a>ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã§ã€Layerã¨ã—ã¦æŒ¯ã‚‹èˆã†<li><code>enabled()</code>ã§ã¯ä¾‹ãˆã€wrapã—ã¦ã„ã‚‹<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html><code>Filter</code></a>ã®å®Ÿè£…ãŒfalseã‚’è¿”ã—ã¦ã‚‚æˆ»ã‚Šå€¤ã¨ã—ã¦ã¯trueã‚’è¿”ã™(Globalã§ç„¡åŠ¹ã«ãªã‚‰ãªã„)<li>Thread localã¨ã¯ã„ãˆGlobalã«å€¤ã‚’ä¿æŒã—ã¦ã„ã‚‹(<code>FILTERING</code>)<li><code>on_event()</code>å®Ÿè£…æ™‚ã«Globalã®<code>FILTERING</code>ã‚’å‚ç…§ã—ã¦Per Filteræ©Ÿèƒ½ã‚’å®Ÿç¾</ul><p>ã¨ä¸­ã€…hackçš„ãªå®Ÿè£…ã¨ãªã£ã¦ãŠã‚Šã€è‡ªå‰ã§<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html><code>Filter</code></a>ã‚’å®Ÿè£…ã™ã‚‹ã ã‘ã§ã¯ã ã‚ã§ã€ã‚ãã¾ã§<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html><code>Filtered</code></a>ã‚’ä½¿ã‚ãªã„ã¨ã„ã‘ãªã„ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<p>ã¨ã„ã†ã“ã¨ã§ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã‹ã‚‰<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html><code>Filtered</code></a>ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒæ¬¡ã®ç›®æ¨™ã§ã™ã€‚<br> <a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html><code>Filtered</code></a>ã®ç”Ÿæˆã«ã¤ã„ã¦ã¯<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber>tracing-subscriber</a>ãŒ<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html#method.with_filter><code>with_filter()</code></a>ã‚’ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€å•é¡Œã¯è¿”ã‚Šå€¤ãŒ<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html><code>Filtered</code></a>ã¨ã„ã†ã“ã¨ã§ã™ã€‚<br> ã©ã†ã„ã†ã“ã¨ã‹ã¨ã„ã„ã¾ã™ã¨ã€ä»Šã‚„ã‚ŠãŸã„ã“ã¨ã¯ã€<code>Filtered&LTMetricsLayer,F,S></code>ã¨ã„ã†å‹ã‚’<a href=https://github.com/tokio-rs/tracing-opentelemetry>tracing-opentelemetry</a>ã®userã«è¿”ã—ãŸã„ã¨ã„ã†ã“ã¨ãªã®ã§ã™ãŒ<br> <a href=https://github.com/tokio-rs/tracing-opentelemetry>tracing-opentelemetry</a>ã¨ã—ã¦ã¯<code>MetricsLayer::new()</code>ãŒpublicãªAPIãªã®ã§ã“ã“ã‚’å¤‰ãˆã¦ã—ã¾ã†ã¨ç ´å£Šçš„å¤‰æ›´ã¨ãªã£ã¦ã—ã¾ã†ã“ã¨ã§ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">MetricLayer</span><span class="z-keyword z-operator z-comparison z-rust"><</span>S<span class="z-keyword z-operator z-comparison z-rust">></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-generic z-rust">Filtered<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>MetricLayerInner,Filter,S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>`
</span></code></pre><p>ä¸Šè¨˜ã®ã‚ˆã†ã«aliasã‚’ä½¿ã†ã‹ã‚‚è€ƒãˆãŸã®ã§ã™ãŒã€ã“ã‚Œã«ã‚‚å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°å°†æ¥çš„ã«ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã«è¿½åŠ ã®è¨­å®šãŒå¿…è¦ã¨ãªã‚Š<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> layer <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">MetricsLayer<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>meter_provider</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">with_foo</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p>ã®ã‚ˆã†ã«<code>with_</code>ã§è¨­å®šã§ãã‚‹APIãŒå¿…è¦ã«ãªã£ãŸå ´åˆã€<code>Filtered</code>ã¯å¤–éƒ¨ã®å‹ãªã®ã§ã€methodã¯è¿½åŠ ã§ããªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚<p>ã“ã“ã§æ€ã£ãŸã®ãŒã€å®Ÿä½“ã¨ã—ã¦ã¯<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber>tracing-subscriber</a>ã®<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html><code>Filtered</code></a>ãªã®ã ã‘ã©ã€å‹ã¨ã—ã¦ã¯userã«ãã‚Œã‚’ã¿ã›ãŸããªã„ã¨ã„ã†çŠ¶æ³ã©ã“ã‹ã§ã¿ãŸã“ã¨ã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚<br> ãã†ã§ã™ã€<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber>tracing-subscriber</a>ã®<a href=https://docs.rs/tracing-subscriber/0.3.17/src/tracing_subscriber/fmt/mod.rs.html#225-232><code>Subscriber</code></a>ã§ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">Subscriber</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-meta z-generic z-rust">    N = <span class="z-meta z-path z-rust">format<span class="z-punctuation z-accessor z-rust">::</span></span>DefaultFields,
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-meta z-generic z-rust">    E = <span class="z-meta z-path z-rust">format<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust">Format<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-path z-rust">format<span class="z-punctuation z-accessor z-rust">::</span></span>Full<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-meta z-generic z-rust">    F = LevelFilter,
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-meta z-generic z-rust">    W = <span class="z-storage z-type z-function z-rust">fn</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-path z-rust">io<span class="z-punctuation z-accessor z-rust">::</span></span>Stdout</span>,
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">inner</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-path z-rust">layer<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust">Layered<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>F, <span class="z-meta z-generic z-rust">Formatter<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>N, E, W<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><a href=https://docs.rs/tracing-subscriber/0.3.17/src/tracing_subscriber/fmt/mod.rs.html#225-232>source</a><p>Genericsã¯ç„¡è¦–ã—ã¦ã€ç€ç›®ã—ãŸã„ã®ãŒã€å®Ÿä½“ã¨ã—ã¦ã¯ã€<code>Layered</code>ãªã®ã§ã™ãŒã€ãã‚Œã‚’innerã¨ã—ã¦wrapã—ãŸå‹ã‚’userã«ã¿ã›ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚<br> ã“ã®æ™‚åˆã‚ã¦ã€<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber>tracing-subscriber</a>ãŒã©ã†ã—ã¦ã“ã†ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã‚‹ã‹ã®æ°—æŒã¡ãŒã‚ã‹ã‚Šã¾ã—ãŸ(å‹æ‰‹ã«)ã€‚<p>ã¨ã„ã†ã“ã¨ã§ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã«<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html><code>Filtered</code></a>ã‚’çµ„ã¿è¾¼ã‚“ã çµæœä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã¨ãªã‚Šã¾ã—ãŸã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">MetricsLayer</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">inner</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-meta z-generic z-rust">Filtered<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>InstrumentLayer, MetricsFilter, S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/e9148988fc053c617cc50f957599e5dc943c3811/src/metrics.rs#L335C1-L337C2>source</a><p>å½¢ã¨ã—ã¦ã¯åŒã˜ã§ã™ã€‚ä»Šã¾ã§ã®<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã®è²¬å‹™ã¯<code>InstrumentLayer</code>ãŒæ‹…ã„ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html><code>Filter</code></a>ã¯<code>MetricsFilter</code>ã«å®Ÿè£…ã™ã‚‹å½¢ã«ã—ã¾ã—ãŸã€‚<br> ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€ã™ã¹ã¦innerã«ç§»è­²ã™ã‚‹å½¢ã§ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html><code>Layer</code></a>ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€Subscriberã‚‚ãã†ã—ã¦ã„ãŸã®ã§å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚<p>ã“ã‚Œã§ã€ç ´å£Šçš„å¤‰æ›´ã‚’è¡Œã†ã“ã¨ãªãã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html#per-layer-filtering>Per-Layer Filtering</a>ã®æ©Ÿèƒ½ã‚’å–ã‚Šè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã—ãŸã€‚<h1 id=allocationmobi-ketai><a aria-label="Anchor link for: allocationmobi-ketai" class=zola-anchor href=#allocationmobi-ketai>Allocationã‚‚é¿ã‘ãŸã„</a></h1><p>ã“ã“ã¾ã§ã§ã€æ©Ÿèƒ½çš„ã«ã¯ç›®æ¨™ã‚’é”æˆã§ããŸã®ã§ã™ãŒã€1ç‚¹ä¸æº€ãŒã‚ã‚Šã¾ã—ãŸã€‚<br> ãã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html><code>Event</code></a> visitå‰ã«ã€<code>Vec</code>ã®allocationãŒç™ºç”Ÿã—ã¦ã—ã¾ã†ç‚¹ã§ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> <span class="z-meta z-generic z-rust">Layer<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">InstrumentLayer</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"></span><span class="z-meta z-impl z-rust"><span class="z-keyword z-other z-rust">where</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust">    S<span class="z-punctuation z-separator z-rust">:</span> Subscriber + <span class="z-keyword z-other z-rust">for</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'span</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-meta z-generic z-rust">LookupSpan<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'span</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"></span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">on_event</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">event</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-meta z-path z-rust">tracing<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust">Event<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>, <span class="z-variable z-parameter z-rust">_ctx</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Context<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span>, S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> attributes <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Vec</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ğŸ‘ˆ ã‚³ã‚³
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> visited_metrics <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Vec</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>   <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ğŸ‘ˆ
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> metric_visitor <span class="z-keyword z-operator z-assignment z-rust">=</span> MetricVisitor <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            attributes<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> attributes<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            visited_metrics<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> visited_metrics<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        event<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">record</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> metric_visitor</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> associate attrivutes with visited metrics
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        visited_metrics
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into_iter</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">for_each</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">|</span></span></span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-variable z-parameter z-rust">metric_name</span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-variable z-parameter z-rust">value</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-section z-parameters z-end z-rust">|</span></span> </span><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">                <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>instruments<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">update_metric</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                    <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>meter<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                    value<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                    metric_name<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                    attributes<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">as_slice</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">                </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-function z-closure z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/e9148988fc053c617cc50f957599e5dc943c3811/src/metrics.rs#L399C1-L424C2>source</a><p><code>Vec</code>ãŒå¿…è¦ãªã®ã¯ã€<code>tracing::info!()</code>ã®ä¸­ã«metricsã¨ä»–ã®fieldãŒã„ãã¤ã‚ã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã‹ã‚‰ã§ã™ã€‚ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå…¥åŠ›ã¯å¯èƒ½ã§ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-path z-rust">tracing<span class="z-punctuation z-accessor z-rust">::</span></span>info<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">    counter<span class="z-punctuation z-accessor z-dot z-rust">.</span>foo <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">    counter<span class="z-punctuation z-accessor z-dot z-rust">.</span>bar <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">2</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">    abc <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>abc<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust">    xyz <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">123</span><span class="z-punctuation z-separator z-rust">,</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-group z-rust"></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><p>ä¸€å¿œã€<a href=https://github.com/tokio-rs/tracing>tracing</a>å´ã§ã€æœ€å¤§fieldæ•°ã®åˆ¶é™(32)ãŒã‚ã‚‹ã®ã§ã™ãŒã€ãã®åˆ†ã®Arrayã‚’ç¢ºä¿ã™ã‚‹ã®ã‚‚resourceã®åŠ¹ç‡çš„ãªåˆ©ç”¨ã®è¦³ç‚¹ã‹ã‚‰å¾Œé€€ã—ã¦ã—ã¾ã†ã‚ˆã†ã«æ€ã‚ã‚Œã¾ã—ãŸã€‚ã¾ãŸæœ€å¤§fieldæ•°ãŒå¢—ãˆã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚<br> ã“ã“ã§ã®å•é¡Œã¯ã€å¤šãã®å ´åˆã€é«˜ã€…æ•°å€‹ã ãŒã€ä¾‹å¤–ã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«å€‹æ•°åˆ¶é™ã¯è¨­ã‘ã‚‰ã‚Œãªã„ã¨ã„ã†çŠ¶æ…‹ã§ã™ã€‚<br> ã“ã†ã„ã†ã‚±ãƒ¼ã‚¹ã«ã¯ã¾ã‚‹ã‚‚ã®ãªã„ã‹ãªã¨èª¿ã¹ã¦ã„ã¦ã¿ã¤ã‘ãŸã®ãŒ<a href=https://docs.rs/smallvec/latest/smallvec/>smallvec</a> crateã§ã™ã€‚<br> <a href=https://docs.rs/smallvec/latest/smallvec/>smallvec</a>ã®èª¬æ˜ã«ã¯<blockquote><p>Small vectors in various sizes. These store a certain number of elements inline, and fall back to the heap for larger allocations. This can be a useful optimization for improving cache locality and reducing allocator traffic for workloads that fit within the inline buffer.</blockquote><p>ã¨ã‚ã‚‹ã®ã§ã€è‡ªåˆ†ã®ç†è§£ãŒæ­£ã—ã‘ã‚Œã°ã€æŒ‡å®šã®æ•°ã¾ã§ã¯stackä¸Šã«ç¢ºä¿ã•ã‚Œã€ãã‚Œã‚’è¶…ãˆãŸå ´åˆã®ã¿ã€é€šå¸¸ã®<code>Vec</code>ã®ã‚ˆã†ã«heapã®allocationãŒç™ºç”Ÿã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚<p>ã¨ã„ã†ã“ã¨ã§ã€<code>SmallVec</code>ã‚’visitæ™‚ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-modifier z-rust">pub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-other z-rust">crate</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">MetricVisitor</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">attributes</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-meta z-generic z-rust">SmallVec<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>KeyValue<span class="z-punctuation z-separator z-rust">;</span></span> <span class="z-constant z-numeric z-integer z-decimal z-rust">8</span><span class="z-punctuation z-section z-group z-end z-rust">]</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">visited_metrics</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-meta z-generic z-rust">SmallVec<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span>, InstrumentType<span class="z-punctuation z-section z-group z-end z-rust">)</span><span class="z-punctuation z-separator z-rust">;</span></span> <span class="z-constant z-numeric z-integer z-decimal z-rust">2</span><span class="z-punctuation z-section z-group z-end z-rust">]</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"> <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">on_event</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">event</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-meta z-path z-rust">tracing<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust">Event<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>, <span class="z-variable z-parameter z-rust">_ctx</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Context<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>'<span class="z-keyword z-operator z-rust">_</span>, S<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> attributes <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">SmallVec<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> visited_metrics <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">SmallVec<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> metric_visitor <span class="z-keyword z-operator z-assignment z-rust">=</span> MetricVisitor <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            attributes<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> attributes<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            visited_metrics<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> visited_metrics<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        event<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">record</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> metric_visitor</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> ...<span class="z-punctuation z-definition z-comment z-rust">*/</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>        
</span></code></pre><p>ã“ã®ã‚ã¨ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã€ç„¡äº‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒé€šã‚Šã¾ã—ãŸã€‚<h1 id=benchmark><a aria-label="Anchor link for: benchmark" class=zola-anchor href=#benchmark>Benchmark</a></h1><p>traceç”¨ã®layerã®benchmarkã¯ã‚ã£ãŸã®ã§ã™ãŒ<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html><code>MetricsLayer</code></a>ã®benchmarkã¯ãªã‹ã£ãŸã®ã§ã€è¿½åŠ ã—ã¾ã—ãŸã€‚<br> <img alt="Metricslayer Benchmark" src=https://storage.googleapis.com/zenn-user-upload/aebd6e928416-20230814.png><br> æœ¬æ¥ã¯æ—§å®Ÿè£…ã¨æ¯”è¼ƒã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€benchmarkã™ã‚‹ã«ã¯ã€ãªã‚“ã‚‰ã‹ã®å½¢ã§æ—§å®Ÿè£…ã‚’å…¬é–‹ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§æ–­å¿µã—ã¾ã—ãŸã€‚<br> ã“ã†ã„ã†ã¨ãã©ã†ã™ã‚Œã°ã„ã„ã‚“ã§ã™ã‹ã­?<h1 id=flamegraph><a aria-label="Anchor link for: flamegraph" class=zola-anchor href=#flamegraph>Flamegraph</a></h1><p>criterionã®benchmarkã«pprofã‚’è¨­å®šã§ãã‚‹ã®ã¯çŸ¥ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ©ç”¨ã—ã¦ã¿ãŸã¨ã“ã‚ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœã‚’å¾—ã‚‰ã‚Œã¾ã—ãŸã€‚ <img alt="Metricslayer Flame Graph" src=https://storage.googleapis.com/zenn-user-upload/dbb8b2dc8703-20230814.png> Metricsæ›´æ–°æ™‚ã®lockå‡¦ç†ã«æ™‚é–“ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<h1 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h1><p><a href=https://github.com/tokio-rs/tracing-opentelemetry>tracing-opentelemetry</a>ã«PRã‚’å‡ºã—ã¦ã¿ãŸéš›è€ƒãˆãŸã“ã¨ã‚’æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚<br> <a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html#per-layer-filtering>Per-Layer Filtering</a>ã®ä»•çµ„ã¿ã‚’çŸ¥ã‚ŒãŸã“ã¨ã‚„ã€<a href=https://opentelemetry.io/>OpenTelemetry</a>ã®metricsé–¢é€£ã®å®Ÿè£…ã«ã¤ã„ã¦ã®å­¦ã³ãŒã‚ã‚Šã¾ã—ãŸã€‚<br> ä»Šå¾Œã‚‚<a href=https://opentelemetry.io/>OpenTelemetry</a>ã‚„<a href=https://github.com/tokio-rs/tracing>tracing</a> ecosystemã¸ã®ç†è§£ã‚’æ·±ã‚ã‚‰ã‚Œã‚Œã°ã¨æ€ã£ã¦ãŠã‚Šã¾ã™ã€‚</div></article></main><footer class=blog-footer><p>Â© 2024 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>