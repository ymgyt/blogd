<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[];gtag(`js`,new Date());gtag(`config`,`G-GTB0KMLN90`)</script><title>ğŸ“— Write Powerful Rust Macrosã‚’èª­ã‚“ã æ„Ÿæƒ³ | Happy developing</title><meta content=ä¸€å†Šã¾ã‚‹ã”ã¨Macroã«ã¤ã„ã¦ã®æœ¬ name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ“— Write Powerful Rust Macrosã‚’èª­ã‚“ã æ„Ÿæƒ³" name=twitter:title><meta content=ä¸€å†Šã¾ã‚‹ã”ã¨Macroã«ã¤ã„ã¦ã®æœ¬ name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/green_book.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ“— Write Powerful Rust Macrosã‚’èª­ã‚“ã æ„Ÿæƒ³</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2024-07-15<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/book/>book</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#du-ndaben>èª­ã‚“ã æœ¬</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#1-going-meta>1 Going meta</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#2-declarative-macros>2 Declarative macros</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#3-a-hello-world-procedural-macro>3 A "Hello, World" procedural macro</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#4-making-fields-public-with-attribute-macros>4 Making fields public with attribute macros</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#5-hiding-information-and-creating-mini-dlss-with-function-like-macros>5 Hiding information and creating mini-DLSs with function-like macros</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#6-testing-a-builder-macro>6 Testing a builder macro</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#7-from-panic-to-result-error-handling>7 From panic to result: Error handling</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#8-builder-with-attributes>8 Builder with attributes</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#9-writing-an-infrastructure-dsl>9 Writing an infrastructure DSL</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#10-macros-and-the-outside-world>10 Macros and the outside world</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><h2 id=du-ndaben><a aria-label="Anchor link for: du-ndaben" class=zola-anchor href=#du-ndaben>èª­ã‚“ã æœ¬</a></h2><a href=https://www.manning.com/books/write-powerful-rust-macros> <figure><div class=fig-images-row><img , alt src=images/macro-book.jpg></div><figcaption>Write Powerful Rust Macros</figcaption></figure> </a><p>è‘—è€…: Sam Van Overmeire<p><a href=https://rustacean-station.org/episode/sam-van-overmeire/>Rustacean station</a>ã¨ã„ã†podcastã§ç´¹ä»‹ã•ã‚Œã¦ã„ã¦ã€ãŠã‚‚ã—ã‚ãã†ã ã£ãŸã®ã§èª­ã‚“ã§ã¿ã¾ã—ãŸã€‚<h2 id=1-going-meta><a aria-label="Anchor link for: 1-going-meta" class=zola-anchor href=#1-going-meta>1 Going meta</a></h2><p>hygieneã‚„compileæ™‚ã«ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ç­‰ã€Rustã®macroã®ç‰¹å¾´ã«ã¤ã„ã¦ã€‚<br> Procedural macroã¯derive macro, attribute macro, function like macroã«åˆ†é¡ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã«ã©ã†ã„ã£ãŸé•ã„ãŒã‚ã‚‹ã®ã‹è‡ªåˆ†ã¯æ›–æ˜§ã«ç†è§£ã—ã¦ã„ãŸã®ã§ã™ãŒã€deriveã¯codeã®è¿½åŠ ã®ã¿ã€attributeã¨function likeã¯codeã®å¤‰æ›´ã‚„å‰Šé™¤ã¾ã§ã§ãã‚‹ã¨ã„ã†é•ã„ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<h2 id=2-declarative-macros><a aria-label="Anchor link for: 2-declarative-macros" class=zola-anchor href=#2-declarative-macros>2 Declarative macros</a></h2><p>Declarative macroã«ã¤ã„ã¦ã®ç« ã§ã™ã€‚<br> Declarative macroã®åŸºæœ¬çš„ãªæ›¸ãæ–¹ã‹ã‚‰ã€hygieneã¾ã§è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<br> Usecaseã¨ã—ã¦ã€newtype patternå®Ÿè£…æ™‚ã®boilerplateã®è¨˜è¿°ç­‰ãŒç´¹ä»‹ã•ã‚Œã¾ã™ã€‚<br> ã¾ãŸã€<code>trace_macros!</code>ã‚„<code>log_syntax!</code>ã«ã‚ˆã‚‹debugæ–¹æ³•ã®è§£èª¬ã‚‚ã‚ã‚Šã¾ã™ã€‚<br> <code>log_syntax!</code>ã¯ä½¿ã£ãŸã“ã¨ãŒãªã‹ã£ãŸã§ã™ã€‚compileæ™‚ã«debugã§ãã‚‹ã®ã§<code>cargo check</code>ã§macroã‚’debugã§ãã¾ã™ã€‚<p>ãã®ä»–ã€ç°¡å˜ãªDSLã‚„é–¢æ•°ã‚’composeã™ã‚‹ä¾‹ãŒè¼‰ã£ã¦ã„ã¾ã™ã€‚<br> Real world usecaseã¨ã—ã¦<code>lazy_static!</code>ã®å®Ÿè£…ã®è§£èª¬ã‚‚ã‚ã‚Šã¾ã™ã€‚<h2 id=3-a-hello-world-procedural-macro><a aria-label="Anchor link for: 3-a-hello-world-procedural-macro" class=zola-anchor href=#3-a-hello-world-procedural-macro>3 A "Hello, World" procedural macro</a></h2><p>3ç« ã‹ã‚‰ã¯procedural macroã®è©±ã«ãªã‚Šã¾ã™ã€‚<br> ã¾ãšderive macroã®èª¬æ˜ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚ projectã®setupã®ä»•æ–¹ã‹ã‚‰macroã®å‡¦ç†ã®æ¦‚è¦ã€<code>syn</code>ã‚„<code>quote</code>ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ãŒè§£èª¬ã•ã‚Œã¾ã™ã€‚<br> ä»¥ä¸‹ã®ã‚ˆã†ãª<code>#[derive(Hello)]</code>ã®å®Ÿè£…ã‚’1è¡Œã¥ã¤èª¬æ˜ã—ã¦ãã‚Œã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">proc_macro<span class="z-punctuation z-accessor z-rust">::</span></span>TokenStream<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">quote<span class="z-punctuation z-accessor z-rust">::</span></span>quote<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">syn<span class="z-punctuation z-accessor z-rust">::</span></span>DeriveInput<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">proc_macro_derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Hello</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">hello</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">item</span><span class="z-punctuation z-separator z-rust">:</span> TokenStream</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> TokenStream</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> ast <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-control z-rust">match</span> <span class="z-meta z-path z-rust">syn<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">parse<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>DeriveInput<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>item</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>input</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> input<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=></span> <span class="z-keyword z-control z-rust">return</span> <span class="z-meta z-path z-rust">TokenStream<span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>err<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_compile_error</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> name <span class="z-keyword z-operator z-assignment z-rust">=</span> ast<span class="z-punctuation z-accessor z-dot z-rust">.</span>ident<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> add_hello_world <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-macro z-rust">quote!</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">#<span class="z-entity z-name z-impl z-rust">name</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">            <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">hello_world</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">                <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>Hello World<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">            </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    add_hello_world<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">hello_world_macro<span class="z-punctuation z-accessor z-rust">::</span></span>Hello<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Hello</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Example</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> e <span class="z-keyword z-operator z-assignment z-rust">=</span> Example <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    e<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">hello_world</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> => Hello World
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>æœ¬æ›¸ã‚’è©¦ã—ã¦ã„ã¦æ°—ã¥ã„ãŸã®ã§ã™ãŒã€<code>cargo expand</code>ã¯main.rsã ã‘ã§ãªãã€moduleã®pathã‚‚æŒ‡å®šã§ãã¦ã€<code>cargo expand path/to/module/hello</code>ã®ã‚ˆã†ã«å®Ÿè¡Œã™ã‚‹ã¨ã€<code>crate::path::to::module::hello</code>ã®å†…å®¹ãŒå±•é–‹ã§ãã¾ã—ãŸã€‚<br> ä»Šã¾ã§ã€main.rsç­‰ã«copyã—ã¦ã„ãŸã®ã§ã™ãŒã€ã“ã‚Œã‹ã‚‰ã¯æ°—ã«ãªã£ãŸã‚³ãƒ¼ãƒ‰ã‚’ã™ãã«expandã§ããã†ã§ã™ã€‚<h2 id=4-making-fields-public-with-attribute-macros><a aria-label="Anchor link for: 4-making-fields-public-with-attribute-macros" class=zola-anchor href=#4-making-fields-public-with-attribute-macros>4 Making fields public with attribute macros</a></h2><p>æœ¬ç« ã§ã¯ã€ä»˜ä¸ã•ã‚ŒãŸå‹ã®fieldã‚’publicã«ã™ã‚‹<code>#[public]</code> attribute macroã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">public</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Example</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">first</span><span class="z-punctuation z-separator z-type z-rust">:</span> String,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">second</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">i64</span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ãŒä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Example</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">first</span><span class="z-punctuation z-separator z-type z-rust">:</span> String,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-modifier z-rust">pub</span> <span class="z-variable z-other z-member z-rust">second</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">i64</span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ã“ã®å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã«ã¯ã€structã®fieldã‚’parseã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> ã“ã®ä¾‹ã‚’é€šã˜ã¦ã€<code>quote::ToTokens</code>ã‚„<code>syn::parse::Parse</code>ã®ä»•çµ„ã¿ã‚’å­¦ã¹ã¾ã™ã€‚<code>proc_macro2::TokenStream</code>ã‚‚ç™»å ´ã—ã¾ã™ã€‚<br> fieldã‚’åŠ å·¥ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ã„ã‚ˆã„ã‚ˆã§ãã‚‹ã“ã¨ãŒåºƒãŒã£ã¦ãã¦ãŠã‚‚ã—ã‚ããªã£ã¦ãã¾ã™ã€‚<br> ã¾ãŸã€real worldã®usecaseã¨ã—ã¦ã€dtolnayå…ˆç”Ÿã®<a href=https://github.com/dtolnay/no-panic>no-panic</a>ã‚‚ç´¹ä»‹ã•ã‚Œã¾ã™ã€‚<br> ç« æœ«ã®exercisesã¾ã§ã‚„ã‚‹ã¨ã€å„ç¨®structã¨enumã®å¯¾å¿œã¾ã§å®Ÿè£…ã§ãã¾ã™ã€‚<h2 id=5-hiding-information-and-creating-mini-dlss-with-function-like-macros><a aria-label="Anchor link for: 5-hiding-information-and-creating-mini-dlss-with-function-like-macros" class=zola-anchor href=#5-hiding-information-and-creating-mini-dlss-with-function-like-macros>5 Hiding information and creating mini-DLSs with function-like macros</a></h2><p>5ç« ã¯<code>foo!()</code>ã®ã‚ˆã†ãªfunction like macroã«ã¤ã„ã¦ã§ã™ã€‚<br> function like macroã¯attribute macroã®ã‚ˆã†ã«inputã®TokenStreamã‚’ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚<br> attribute macroã¨ã®é•ã„ã¯ã€macroã®å…¥åŠ›ã¨ã—ã¦ã€rustã®codeã«é™ã‚‰ãšä»»æ„ã®å…¥åŠ›ã‚’æ¸¡ã›ã‚‹ç‚¹ã§ã™ã€‚<br> ã“ã®ç‰¹æ€§ã‹ã‚‰ã€<code>sqlx</code>ã‚„<code>yew</code>ã§ã¯ã€SQLã‚„htmlã‚’å…¥åŠ›ã«ã¨ã‚Œã‚‹macroãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> æœ¬ç« ã§ã¯ã€2ç« ã§å®Ÿè£…ã—ãŸã€compose macroã®prodeduralç‰ˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">compose_macro<span class="z-punctuation z-accessor z-rust">::</span></span>compose<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">add_one</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">n</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i32</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-storage z-type z-rust">i32</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    n <span class="z-keyword z-operator z-arithmetic z-rust">+</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">to_string</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">n</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">i32</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> String</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    n<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_string</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">with_prefix</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">s</span><span class="z-punctuation z-separator z-rust">:</span> String</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> String</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">format!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>prefix_<span class="z-constant z-other z-placeholder z-rust">{s}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> composed <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-macro z-rust">compose!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>add_one<span class="z-punctuation z-accessor z-dot z-rust">.</span>to_string<span class="z-punctuation z-accessor z-dot z-rust">.</span>with_prefix</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-function z-rust">composed</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">2</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> => "prefix_3"
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><h2 id=6-testing-a-builder-macro><a aria-label="Anchor link for: 6-testing-a-builder-macro" class=zola-anchor href=#6-testing-a-builder-macro>6 Testing a builder macro</a></h2><p>6ç« ã§ã¯ã€<code>#[derive(Builder)]</code> macroã«ã‚ˆã‚‹builder patternã®å®Ÿè£…ã‚’é€šã—ã¦ã€macroã®testã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚ã¾ãŸã€<code>proc-macro2</code>ã‚’åˆ©ç”¨ã—ã¦ã€procedural macroã®å®Ÿè£…ã‚’é€šå¸¸ã®lib crateã«ç§»è­²ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã‚‚èª¬æ˜ã•ã‚Œã¾ã™ã€‚<br> ä»–ã®procedural macroã«ã¤ã„ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦dtolnayå…ˆç”Ÿã®<a href=https://github.com/dtolnay/proc-macro-workshop>proc-macro-workshop</a>ã‚„jon gjengsetå…ˆç”Ÿã®<a href="https://www.youtube.com/watch?v=geovSK3wMB8">Procedural Macros in Rust</a> å‹•ç”»ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<h2 id=7-from-panic-to-result-error-handling><a aria-label="Anchor link for: 7-from-panic-to-result-error-handling" class=zola-anchor href=#7-from-panic-to-result-error-handling>7 From panic to result: Error handling</a></h2><p>æœ¬ç« ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãª<code>panic!()</code>ã™ã‚‹é–¢æ•°ã‚’Resultã‚’è¿”ã™é–¢æ•°ã«å¤‰æ›ã™ã‚‹<code>#[panic_to_result]</code>ã‚’é€šã—ã¦ã€é–¢æ•°ã®å¤‰æ›ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">panic_to_result</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">create_person</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">name</span><span class="z-punctuation z-separator z-rust">:</span> String, <span class="z-variable z-parameter z-rust">age</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">u32</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> Person</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">if</span> age <span class="z-keyword z-operator z-comparison z-rust">></span> <span class="z-constant z-numeric z-integer z-decimal z-rust">30</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-macro z-rust">panic!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>I hope I die before I get old<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    Person <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        name<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        age<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">create_person</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">name</span><span class="z-punctuation z-separator z-rust">:</span> String, <span class="z-variable z-parameter z-rust">age</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">u32</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Result</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>Person,<span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">if</span> age <span class="z-keyword z-operator z-comparison z-rust">></span> <span class="z-constant z-numeric z-integer z-decimal z-rust">30</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">return</span> <span class="z-support z-type z-rust">Err</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>I hope I die before I get old<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    Person <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        name<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        age<span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>å¤‰æ›æ™‚ã®ã‚¨ãƒ©ãƒ¼ã€ä¾‹ãˆã°<code>panic!()</code>ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„å ´åˆã‚’ãƒ¦ãƒ¼ã‚¶ã«ã‚ã‹ã‚Šã‚„ã™ãä¼ãˆã‚‹æ–¹æ³•ãŒè§£èª¬ã•ã‚Œã¾ã™ã€‚<a href=https://docs.rs/proc-macro-error/latest/proc_macro_error/>proc-macro-error</a>ã¯çŸ¥ã‚‰ãªã‹ã£ãŸã®ã§å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚<h2 id=8-builder-with-attributes><a aria-label="Anchor link for: 8-builder-with-attributes" class=zola-anchor href=#8-builder-with-attributes>8 Builder with attributes</a></h2><p>8ç« ã§ã¯ã€attributesã‚’æ‰±ã†æ–¹æ³•ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚ ä»¥å‰ã®Builder macroã§renameã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Builder</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">Example</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">rename</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>bar<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">foo</span><span class="z-punctuation z-separator z-type z-rust">:</span> String,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-path z-rust">Example<span class="z-punctuation z-accessor z-rust">::</span></span>builder<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">bar</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>bar<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">build</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>attributeã«ã‚‚ã€<code>#[rename(foo)]</code>ã§ã‚ã£ãŸã‚Šã€<code>#[rename(key=value)]</code>ã¨æ›¸ãæ–¹ãŒè¤‡æ•°ã‚ã‚Šã€ãã‚Œãã‚Œsynä¸Šã§ã®è¡¨ç¾ãŒç•°ãªã‚Šã¾ã™ã€‚<br> ã¾ãŸã€ä»Šã®Builderã®å®Ÿè£…ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãŒé©åˆ‡ã«builderã®methodã‚’å‘¼ã³å‡ºã—ã‹ã©ã†ã‹ã‚’runtimeæ™‚ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã‚’compileæ™‚ã«ãƒã‚§ãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã«ã„ã‚ã‚†ã‚‹type state patternã‚’å®Ÿè£…ã—ã¾ã™ã€‚ attribute macroã®å ´åˆã€ä»–ã®attributeã‚’ä¿æŒã™ã‚‹ã‹ã©ã†ã‹ã‚‚åˆ¤æ–­ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€<code>#[allow()]</code>ç­‰ã®ä»–ã®attributeã‚’ä¿æŒã™ã‚‹ã‹å¦ã‹ã‚’åˆ¤å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã¯çŸ¥ã‚‰ãªã‹ã£ãŸã®ã§å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚<h2 id=9-writing-an-infrastructure-dsl><a aria-label="Anchor link for: 9-writing-an-infrastructure-dsl" class=zola-anchor href=#9-writing-an-infrastructure-dsl>9 Writing an infrastructure DSL</a></h2><p>9ç« ã§ã¯ã€function like macroã§DSLã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚<br> å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«AWSã®resourceã‚’å®£è¨€ã™ã‚‹terraformã®ã‚ˆã†ãªInfrastructure as Code(IaC) macroã‚’ä½œã‚Šã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-support z-macro z-rust">iac!</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    bucket uniquename <span class="z-keyword z-operator z-rust">=></span> lambda <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        name <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>name<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-separator z-rust">,</span> mem <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">1024</span><span class="z-punctuation z-separator z-rust">,</span> time <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">10</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre><p>ã“ã®å®Ÿè£…ã®ä¸­ã§ã€<code>syn::custom_keyword!</code>ã‚„<code>syn::parenthesized</code>ã®ä½¿ã„æ–¹ã‚‚ç´¹ä»‹ã•ã‚Œã¾ã™ã€‚ From the real worldã§ã¯declaratve macroã¨procedural macroã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ã‚ã‚Œã¦ã„ã‚‹ä¾‹ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<h2 id=10-macros-and-the-outside-world><a aria-label="Anchor link for: 10-macros-and-the-outside-world" class=zola-anchor href=#10-macros-and-the-outside-world>10 Macros and the outside world</a></h2><p>æœ€å¾Œã®10ç« ã¯compileæ™‚ã«yaml fileã‹ã‚‰<code>Config</code> structã‚’ç”Ÿæˆã™ã‚‹<code>config!</code>ã‚’å®Ÿè£…ã—ã¾ã™ã€‚<br> æœ¬ç« ã§ã¯proc macro crateã®featureåˆ¶å¾¡ã‚„documentã«ã¤ã„ã¦ã®è§£èª¬ã‚‚ã‚ã‚Šã¾ã™ã€‚<br> æœ€å¾Œã«ã¾ã¨ã‚ã¨ã—ã¦ã€<code>#[tokio::main]</code>ã®srcã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<br> ã¾ãŸã€æœ¬æ›¸ã§ç´¹ä»‹ã—ãã‚Œãªã‹ã£ãŸsynã®<a href=https://www.infoq.com/articles/rust-procedural-macros-replace-panic/><code>Fold</code> traitã®è§£èª¬è¨˜äº‹</a>ã‚„proc macroå®Ÿè£…æ™‚ã«åˆ©ç”¨ã§ãã‚‹crateãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>Procedural macroã ã‘ã§ã»ã¼1å†Šæ›¸ã‹ã‚Œã¦ãŠã‚Šã€å®Ÿéš›ã«codeã‚’æ›¸ããªãŒã‚‰å°‘ã—ãšã¤æ”¹è‰¯ã—ã¦ã„ãã®ã§ã¨ã¦ã‚‚æ¥½ã—ãèª­ã‚ã¾ã—ãŸã€‚<br> ç« æœ«ã®exerciseã®ç­”ãˆã‚‚appendixã«è¼‰ã£ã¦ã„ã¦ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚<br> ä»Šã¾ã§procedural macroã®å®Ÿè£…ã‚’èª­ã‚“ã§ã„ãªã‹ã£ãŸã®ã§ã™ãŒã€ã“ã‚Œã‹ã‚‰ã¯è‰²ã€…ãªlibã®å®Ÿè£…ã‚’èª­ã‚“ã§ã¿ã‚ˆã†ã¨æ€ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</div></article></main><footer class=blog-footer><p>Â© 2024 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>