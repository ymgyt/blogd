<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[];gtag(`js`,new Date());gtag(`config`,`G-GTB0KMLN90`)</script><title>ğŸ¦€ Rustã®lifetimeã¨variance | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ¦€ Rustã®lifetimeã¨variance</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2021-03-21<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#changelog>CHANGELOG</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#subtypenoyi-wei>Subtypeã®æ„å‘³</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#lifetimetosubtype>Lifetimeã¨subtype</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#variance>Variance</a> <ul><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#covariant>covariant</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#contravariant>contravariant</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#invariant>invariant</a></ul><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#cell-t>Cell&LTT></a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#ju-ti-li>å…·ä½“ä¾‹</a> <ul><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#strtok>strtok</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#evil-feeder>evil_feeder</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#messagecollector>MessageCollector</a></ul><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/nomicon>nomicon</a> ã‚’èª­ã‚“ã§ã„ã¦<a href=https://doc.rust-lang.org/nomicon/subtyping.html>Subtyping and Variance</a> ã®è©±ãŒã§ã¦ããŸã¨ãã«ã©ã†ã—ã¦ç¶™æ‰¿ã®æ¦‚å¿µãŒãªã„Rustã«varianceã®è©±ãŒã§ã¦ãã‚‹ã®ã‹ãªã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚<br> ãã®å¾Œã€Rustã®å‹•ç”»ã‚’youtubeã«æŠ•ç¨¿ã•ã‚Œã¦ã„ã‚‹<a href=https://twitter.com/jonhoo>Jon Gjengsetã•ã‚“</a> ã®<a href="https://www.youtube.com/watch?v=iVYWDIW71jk&ab_channel=JonGjengset">Crust of Rust: Subtyping and Variance</a> ã‚’è¦‹ã¦è‡ªåˆ†ãªã‚Šã«ã™ã“ã—ç†è§£ãŒé€²ã‚“ã ã®ã§ãƒ–ãƒ­ã‚°ã«æ›¸ãã“ã¨ã«ã—ã¾ã—ãŸã€‚<p>å…·ä½“çš„ã«ã¯nomiconã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹varianceã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã†ã¡ä»¥ä¸‹ã®ç†è§£ã‚’è©¦ã¿ã¾ã™ã€‚<table><thead><tr><th><th><code>'a</code><th><code>T</code><th><code>U</code><tbody><tr><td><code>&'a T</code><td>covariant<td>covariant<td><tr><td><code>&'a mut T</code><td>covariant<td>invariant<td><tr><td><code>fn(T) -> U</code><td><td>contravariant<td>covariant<tr><td><code>Cell&LTT></code><td><td>invariant<td></table><h2 id=changelog><a aria-label="Anchor link for: changelog" class=zola-anchor href=#changelog>CHANGELOG</a></h2><ul><li>2023-02-08 fix: update broken link to https://github.com/sunshowers-code/lifetime-variance</ul><h2 id=subtypenoyi-wei><a aria-label="Anchor link for: subtypenoyi-wei" class=zola-anchor href=#subtypenoyi-wei>Subtypeã®æ„å‘³</a></h2><p>å½¢å¼çš„ã«ã¯ï¼’ã¤ã®å‹ãŒã‚ã‚‹ã¨ãã«ã‚ã‚‹ã‹ãªã„ã‹ã®é–¢ä¿‚ã€‚<br> ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã¯ã€and moreã¨ã‹ã€<a href="https://youtu.be/iVYWDIW71jk?t=1627">å°‘ãªãã¨ã‚‚åŒç¨‹åº¦ã«ã¯å½¹ç«‹ã¤(at least as useful as)ã¨èª¬æ˜</a> ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> Cat is an Animal and more ã¿ãŸã„ãªã€‚<h2 id=lifetimetosubtype><a aria-label="Anchor link for: lifetimetosubtype" class=zola-anchor href=#lifetimetosubtype>Lifetimeã¨subtype</a></h2><p><a href=https://doc.rust-lang.org/nomicon/index.html>nomicon</a> ã§ã¯fairly arbitary constructã¨å‰ç½®ãã‚’ãŠãã¤ã¤ã‚‚lifetimeã‚’å‹ã¨ã—ã¦ã¨ã‚‰ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚<br> ã©ã†ã„ã†ã“ã¨ã‹ã¨ã„ã†ã¨ã€lifetimeã¯ã‚³ãƒ¼ãƒ‰ã®é ˜åŸŸ(regions of code)ã®ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ã®é ˜åŸŸã¯å«ã‚“ã§ã‚‹ã‹å«ã‚“ã§ãªã„ã‹ã®é–¢ä¿‚ã‚’è€ƒãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ã‚ã‚‹ã‚³ãƒ¼ãƒ‰é ˜åŸŸ(<code>'big</code>)ãŒåˆ¥ã®ã‚³ãƒ¼ãƒ‰é ˜åŸŸ(<code>'small</code>)ã‚’å«ã‚“ã§ã„ã‚‹ã¨ã<br> <code>'big</code>ã¯<code>'small</code>ã®subtypeã¨ã„ãˆã¾ã™ã€‚ subtypeã®é–¢ä¿‚ã‚’and moreã¨è€ƒãˆã‚‹ã¨ã€<code>'big</code> is <code>'small</code> and moreã¨ã„ãˆã‚‹ã®ã§ç­‹ãŒã¨ãŠã£ã¦ã„ã¾ã™ã­ã€‚<p>ã“ã‚“ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚<pre class=z-code><code><span class="z-text z-plain">{ 
</span><span class="z-text z-plain">  let x: 'big = ...
</span><span class="z-text z-plain">  {
</span><span class="z-text z-plain">    let y: 'small = ...
</span><span class="z-text z-plain">    // ...
</span><span class="z-text z-plain">  }
</span><span class="z-text z-plain">}
</span></code></pre><p><code>'static</code>ã¯ä»–ã®lifetimeã‚’outlivesã™ã‚‹ã®ã§ã€å…¨ã¦ã®lifetimeã®subtypeã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚<p>ãŸã ã—ã€lifetimeãã‚Œè‡ªä½“ã§å˜ç‹¬ã®å‹ã«ãªã‚‹ã“ã¨ã¯ãªãã€ã‹ãªã‚‰ãš <code>&'a u32</code>ã‚„<code>iterMut<'a, u32></code>ã®ã‚ˆã†ã«ã‚ã‚‹å‹ã®ä¸€éƒ¨ã¨ã—ã¦ç¾ã‚Œã‚‹ã€‚ãã“ã§ã€subtypeã‚’çµ„ã¿åˆã‚ã›ãŸã¨ãã«ã©ã†ãªã‚‹ã®ã‹ã®è©±ã«ãªã‚ŠvarianceãŒã§ã¦ãã¾ã™ã€‚<h2 id=variance><a aria-label="Anchor link for: variance" class=zola-anchor href=#variance>Variance</a></h2><p>varianceã¨ã¯type constructorãŒã‚‚ã¤æ€§è³ªã€‚Rustã§ã„ã†type constructorã¨ã¯å‹<code>T</code>ã‚’ã†ã‘ã¨ã£ã¦<code>Vec&LTT></code>ã‚’è¿”ã™<code>Vec</code>ã ã£ãŸã‚Šã€<code>&</code>ã‚„<code>&mut</code>ã®ã“ã¨ã€‚ä»¥å¾Œã¯<a href=https://doc.rust-lang.org/nomicon/index.html>nomicon</a>ã®ä¾‹ã«ãªã‚‰ã£ã¦<code>F&LTT></code>ã¨æ›¸ãã¾ã™ã€‚<br> å‹<code>Sub</code>ãŒå‹<code>Super</code>ã®subtypeã¨ã—ã¦ã€varianceã¯covariant, contravariant, invariantã®3ç¨®é¡ã«åˆ†é¡ã§ãã¾ã™ã€‚<br> ä»¥ä¸‹ãã‚Œãã‚Œã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã™ã€‚<h3 id=covariant><a aria-label="Anchor link for: covariant" class=zola-anchor href=#covariant>covariant</a></h3><p><code>F&LTSub></code>ãŒ<code>F&LTSuper></code>ã®subtypeãªã‚‰covariantã€‚<br> <code>s: &'a str</code>å‹ã«<code>&'static str</code>ã‚’æ¸¡ã›ã‚‹ã®ã¯ã€<code>&</code>ãŒcovariantã ã‹ã‚‰ã¨ã„ãˆã¾ã™ã€‚<br> (<code>'static</code> subtype <code>'a</code>) -> (<code>&'static str</code> subtype <code>&'a str</code>)<br> å¼•æ•°ã®å‹ã®subtypeã®é–¢ä¿‚ãŒæˆ»ã‚Šå€¤ã®å‹ã®é–¢ä¿‚ã«ãã®ã¾ã¾åæ˜ ã•ã‚Œã‚‹ã®ã§ç´ ç›´ã§ç›´æ„Ÿçš„ãªé–¢ä¿‚ã ã¨æ€ã„ã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> s <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> x<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>hello world<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> y<span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> :&'y str <span class="z-punctuation z-definition z-comment z-rust">*/</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>s<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> y <span class="z-keyword z-operator z-assignment z-rust">=</span> x<span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre><h3 id=contravariant><a aria-label="Anchor link for: contravariant" class=zola-anchor href=#contravariant>contravariant</a></h3><p><code>F&LTSuper></code>ãŒ<code>F&LTSub></code>ã®subtypeãªã‚‰contravariantã€‚<br> ã“ã‚Œã ã‘ã¿ã¦ã‚‚ã‚ˆãã‚ã‹ã‚‰ãªã„ã®ã§å…·ä½“ä¾‹ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">contravariant</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">f</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-function z-rust">fn</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-function z-rust">f</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>hello<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ã“ã®é–¢æ•°ã«<code>fn(&'a str) -> ()</code>ãªé–¢æ•°ã‚’æ¸¡ã›ã‚‹ã¨ã„ã†ã“ã¨ã‚’ã„ã£ã¦ã„ã¾ã™ã€‚ <code>'a</code>ã¯<code>'static</code>ã®super typeãªã®ã§<code>Fn(&'a str) -> ()</code>ã¯<code>Fn(&'static str)</code>ã®subtypeã«ãªã‚Šã¾ã™ã€‚<br> æ„å‘³ã¨ã—ã¦ã¯ä¸Šè¨˜ã®<code>contravariant</code>é–¢æ•°ã¯æ¸¡ã•ã‚ŒãŸé–¢æ•°ã«<code>'static</code> lifetimeã‚’ã‚‚ã¤å¤‰æ•°ã‚’æ¸¡ã—ã¦ã‚ˆã³ã ã—ã¦ãã‚Œã‚‹ã¨èª­ã‚ã¾ã™ã€‚ãã®é–¢æ•°ã«å¿…ãšã—ã‚‚æ°¸ç¶šã™ã‚‹å¿…è¦ã¯ãªãæ¸¡ã—ãŸé–¢æ•°ã®å®Ÿè¡Œä¸­ã ã‘æœ‰åŠ¹ãªæ–‡å­—åˆ—ã§ååˆ†ãªclosureã‚’æ¸¡ã›ã‚‹ã¨ã„ã†æ„Ÿã˜ã§ã—ã‚‡ã†ã‹ã€‚å¼•æ•°ã«å¯¾ã™ã‚‹åˆ¶ç´„ã‚’å¼±ãã—ãŸé–¢æ•°ã¯ã¤ã‚ˆã„åˆ¶ç´„ã‚’è¦æ±‚ã™ã‚‹é–¢æ•°ã®subtypeã«ãªã‚‹ã¨è€ƒãˆã‚Œã°è‡ªç„¶ã¨ã„ãˆã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚<h3 id=invariant><a aria-label="Anchor link for: invariant" class=zola-anchor href=#invariant>invariant</a></h3><p>ã‚‚ã†ä¸€åº¦varianceè¡¨ã‚’ã¿ã¦ã¿ã‚‹ã¨invariantã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<table><thead><tr><th><th><code>'a</code><th><code>T</code><tbody><tr><td><code>&'a mut T</code><td>covariant<td>invariant</table><p>ã¾ãš<code>T</code>ã«ã¤ã„ã¦invariantã‹ã‚‰ã¿ã¦ã„ãã¾ã™ã€‚<code>T</code>ã«ã¤ã„ã¦invariantãªãŠã‹ã’ã§ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã®compileãŒã¨ãŠã‚‰ãªã„ã‚ˆã†ã«ãªã£ã¦ãã‚Œã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">invariant_1</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">s</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-storage z-type z-rust">str</span>, <span class="z-variable z-parameter z-rust">x</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-storage z-type z-rust">str</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-operator z-arithmetic z-rust">*</span>s <span class="z-keyword z-operator z-assignment z-rust">=</span> x<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">invariant_1_no_compile</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> x<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>hello<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> z <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> signature:  &mut &'a      str, &'a str
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> providing:  &mut &'static str, &'a str
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-function z-rust">invariant_1</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> x<span class="z-punctuation z-separator z-rust">,</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-keyword z-operator z-arithmetic z-rust">*</span>z</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-function z-rust">drop</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>z</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> x<span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ã‚‚ã—compileãŒé€šã£ã¦ã—ã¾ã†ã¨ã€<code>'static</code>ãªå‚ç…§ã®ã¯ãšãŒdropã•ã‚ŒãŸé ˜åŸŸã‚’å‚ç…§ã§ãã¦ã—ã¾ã†ã“ã¨ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚<br> compile errorã«ãªã£ã¦ãã‚Œã‚‹ç†ç”±ã¯ã€<code>&'a mut T</code>ãŒTã«ã¤ã„ã¦invariantãªãŠã‹ã’ã§<br> <code>&'a mut &'static str</code>ãŒ<code>&'a mut &'a str</code>ã®subtypeã«ãªã‚‰ãªã„ã‹ã‚‰ã§ã™ã€‚<code>&'static str</code>ã¯<code>&</code>ãŒcovariantãªã®ã§<code>&'a str</code>ã®subtypeã§ã™ãŒã€ãã®é–¢ä¿‚ã¯<code>& mut</code>ã§å¤‰æ›ã•ã‚Œã‚‹ã¨ç¶­æŒã•ã‚Œã¾ã›ã‚“ã€‚<p>æ¬¡ã«<code>'a</code>ã«ã¤ã„ã¦ã¯covariantã«ã¤ã„ã¦ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">test_mut_ref_covariant</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> y <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-language z-rust">true</span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> z <span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span>&'y bool <span class="z-punctuation z-definition z-comment z-rust">*/</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> y<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> x <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Box</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-language z-rust">true</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> x<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-storage z-type z-rust">bool</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Box</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>leak<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>x</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    z <span class="z-keyword z-operator z-assignment z-rust">=</span> x<span class="z-punctuation z-terminator z-rust">;</span> <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> &'a mut bool &LT- &'static mut bool
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><code>Box::leak()</code>ã§heapã«ç¢ºä¿ã—ãŸå€¤ã®<code>&'static mut</code>å‚ç…§ã‚’ä½œã‚Œã¾ã™ã€‚<br> <code>&'a mut T</code>ãŒ<code>'a</code>ã«ã¤ã„ã¦ã¯covariantãªãŠã‹ã’ã§ã€lifetimeãŒã‚ˆã‚Šé•·ã„å ´åˆã«ã¯è‡ªç„¶ãªä»£å…¥ãŒè¨±å¯ã•ã‚Œã¾ã™ã­ã€‚<h2 id=cell-t><a aria-label="Anchor link for: cell-t" class=zola-anchor href=#cell-t><code>Cell&LTT></code></a></h2><p>Cellã«ã¤ã„ã¦ã¯<a href=https://github.com/sunshowers-code/lifetime-variance>lifetime-variance-example</a>ã«éå¸¸ã«ã‚ã‹ã‚Šã‚„ã™ã„ä¾‹ãŒã®ã£ã¦ã„ã¾ã™ã€‚ <code>Cell&LTT></code>ã¯Tã«ã¤ã„ã¦invariantãªã®ã§<code>Cell<&'static str></code>ã¯<code>Cell<&'a str></code>ã®subtypeã«ãªã‚Œã¾ã›ã‚“ã€‚ãªã®ã§ä»¥ä¸‹ã®é–¢æ•°ã¯compileã§ãã¾ã›ã‚“ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">cell_shortener</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span>, <span class="z-storage z-modifier z-lifetime z-rust">'b</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">s</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-meta z-generic z-rust">Cell<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-meta z-generic z-rust">Cell<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'b</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    s
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ãªã‚“ã¨ãªãã§ã™ãŒ<code>Cell<&'a str></code>å‹ã«<code>Cell<&'static str></code>ã‚’assignã§ãã¦ã‚‚å•é¡Œãªã„ã‚ˆã†ã«æ€ãˆã¾ã™ã€‚ã—ã‹ã—ä»¥ä¸‹ã®ä¾‹ã‹ã‚‰ãã‚Œã¯èªã‚ã‚‰ã‚Œãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">cell_counterexample</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> foo<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Cell<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Cell<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>foo<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> owned_string<span class="z-punctuation z-separator z-rust">:</span> <span class="z-support z-type z-rust">String</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>non_static<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_owned</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">  
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> If we pretend that cell_shortener works
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> shorter_foo <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">cell_shortener</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span>foo</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">  
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> then shorter_foo and foo would be aliases of each other, which would mean that you could use
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> shorter_foo to replace foo's Cell with a non-static string:
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    shorter_foo<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">replace</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span>owned_string</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">  
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> now foo, which is an alias of shorter_foo, has a non-static string in it! Whoops.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>https://github.com/sunshowers/lifetime-variance-example/blob/ac8fc6cbee7bfd9b70a8c58973a891ed8a5482a7/src/lib.rs#L62<p>ãŸã—ã‹ã«<code>Cell&LTT></code>ã‚’covariantã«ã—ã¦ã—ã¾ã†ã¨å±é™ºãªæ“ä½œãŒå¯èƒ½ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚<br> çµå±€ã¯interior mutabilityã‚’æä¾›ã—ã¦ã„ã‚‹å‹ã¯å®Ÿè³ªçš„ã«ã¯<code>&mut</code>ã¨åŒã˜ã“ã¨ãŒã§ãã‚‹ã“ã¨ã®å¸°çµã¨ã„ãˆã‚‹ã‚“ã§ã—ã‚‡ã†ã‹ã€‚<h2 id=ju-ti-li><a aria-label="Anchor link for: ju-ti-li" class=zola-anchor href=#ju-ti-li>å…·ä½“ä¾‹</a></h2><h3 id=strtok><a aria-label="Anchor link for: strtok" class=zola-anchor href=#strtok><code>strtok</code></a></h3><p>ã“ã“ã§ã¯<a href="https://www.youtube.com/watch?v=iVYWDIW71jk&ab_channel=JonGjengset">Crust of Rust: subtyping and Variance</a>ã§ã¨ã‚Šã‚ã’ã‚‰ã‚Œã¦ã„ãŸä¾‹ã‚’ã¿ã¦ã„ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªé–¢æ•°ã‚’è€ƒãˆã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">strtok</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">s</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-storage z-type z-rust">str</span>, <span class="z-variable z-parameter z-rust">delimiter</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">char</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-storage z-type z-rust">str</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">if</span> <span class="z-storage z-type z-rust">let</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>i</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> s<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">find</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>delimiter</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> prefix <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span>s<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-keyword z-operator z-range z-rust">..</span>i<span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> suffix <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span>s<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>i <span class="z-keyword z-operator z-arithmetic z-rust">+</span> delimiter<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">len_utf8</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-keyword z-operator z-range z-rust">..</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-operator z-arithmetic z-rust">*</span>s <span class="z-keyword z-operator z-assignment z-rust">=</span> suffix<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        prefix
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span> <span class="z-keyword z-control z-rust">else</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> prefix <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span>s<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-operator z-arithmetic z-rust">*</span>s <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        prefix
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>c++ã®<a href=http://www.cplusplus.com/reference/cstring/strtok/>strtok</a> ã¨ã„ã†é–¢æ•°ã‚‰ã—ã„ã§ã™ã€‚å‡¦ç†å†…å®¹è‡ªä½“ã¯é‡è¦ã§ã¯ãªã„ã®ã§ã™ãŒã€å¼•æ•°ã®æ–‡å­—åˆ—sã‚’delimiterã§splitã—ã¦æœ€åˆã®elementã‚’è¿”ã—ã€sã‚’æ¬¡ã®elementã®å…ˆé ­ã«ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚é€£ç¶šã—ã¦ã‚ˆã¶ã“ã¨ã§ã€Rustã§ã„ã†ã¨ã“ã‚ã®splitã—ã¦Iteratorã‚’å–å¾—ã™ã‚‹æ„Ÿã˜ã®é–¢æ•°ã§ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">test</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">test_strtok</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> x<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>hello world<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-function z-rust">strtok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> x<span class="z-punctuation z-separator z-rust">,</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">'</span> <span class="z-punctuation z-definition z-string z-end z-rust">'</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p><code>strtok</code>ã‚’ä¸Šè¨˜ã®ã‚ˆã†ã«å‘¼ã³å‡ºã™ã¨compile errorã«ãªã‚Šã¾ã™ã€‚<pre class=z-code><code><span class="z-text z-plain">error[E0597]: `x` does not live long enough
</span><span class="z-text z-plain">   --> src/main.rs:115:16
</span><span class="z-text z-plain">    |
</span><span class="z-text z-plain">113 |         let mut x: &'static str = "hello world";
</span><span class="z-text z-plain">    |                    ------------ type annotation requires that `x` is borrowed for `'static`
</span><span class="z-text z-plain">114 |
</span><span class="z-text z-plain">115 |         strtok(&mut x, ' ');
</span><span class="z-text z-plain">    |                ^^^^^^ borrowed value does not live long enough
</span><span class="z-text z-plain">116 |     }
</span></code></pre><p>ãªã«ãŒãŠãã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨<pre class=z-code><code><span class="z-text z-plain">// 'aã¯genericã§ 'xã¯å…·ä½“çš„ãªlifetimeã¨æ€ã£ã¦ãã ã•ã„ã€‚
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">// signature: <'a> &'a mut  &'a      str
</span><span class="z-text z-plain">// providing:      &'x mut  &'static str
</span><span class="z-text z-plain">               
</span><span class="z-text z-plain">// signature:      &'static &'static str
</span><span class="z-text z-plain">// providing:      &'x mut  &'static str
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">// signature:      &'static &'static str
</span><span class="z-text z-plain">// providing:      &'static mut  &'static str
</span></code></pre><p>å¤‰æ•°<code>x</code>ã®<code>'static</code> lifetiemã¨<code>strtok</code>ã®lifetimeã®å‹ã‹ã‚‰lifetime generic <code>'a</code>ãŒ<code>'static</code>ã¨è§£é‡ˆã•ã‚Œã€æœ€çµ‚çš„ã«<br> <code>strtok(& /* 'static */ mut x)</code>ã«ãªã£ã¦ã—ã¾ã†ãŒã€xã¯stackå¤‰æ•°ãªã®ã§staticã§ã¯ãªã "does not live long enough"ã«ãªã£ã¦ã—ã¾ã†ã€‚(ã¨ã„ã†ç†è§£ã§ã™)<p>ãã“ã§ã©ã†ã™ã‚Œã°ã‚ˆã„ã‹ã¨ã„ã†ã¨ã€å•é¡Œã¯<code>strtok</code>ã®lifetime genericãŒã²ã¨ã¤ã—ã‹ãªã„ãŸã‚ã«<code>&mut x</code>è‡ªä½“ã®lifetimeã‚‚ã²ãã¥ã‚‰ã‚Œã¦<code>'sattic</code>ã«ãªã£ã¦ã—ã¾ã†ã“ã¨ã ã£ãŸã®ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">strtok_2</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span>, <span class="z-storage z-modifier z-lifetime z-rust">'b</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">s</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'b</span> <span class="z-storage z-type z-rust">str</span>, <span class="z-variable z-parameter z-rust">delimiter</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">char</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'b</span> <span class="z-storage z-type z-rust">str</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span><span class="z-comment z-block z-rust"><span class="z-punctuation z-definition z-comment z-rust">/*</span> <span class="z-punctuation z-definition z-comment z-rust">*/</span></span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ã“ã†ã™ã‚‹ã¨ã“ã§compileãŒã¨ãŠã‚‹ã‚ˆã†ã«ãªã‚Šã¯ã‚Œã¦ãƒ†ã‚¹ãƒˆã‚‚æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<pre class=z-code><code><span class="z-text z-plain">// signature: <'a, 'b> &'a mut &'b      str
</span><span class="z-text z-plain">// providing:          &'x mut &'static str
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">// signature:          &'x mut &'static str
</span><span class="z-text z-plain">// providing:          &'x mut &'static str
</span></code></pre><pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">test</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">test_strtok</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> x<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>hello world<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> hello <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-function z-rust">strtok_2</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> x<span class="z-punctuation z-separator z-rust">,</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">'</span> <span class="z-punctuation z-definition z-string z-end z-rust">'</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">assert_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>hello<span class="z-punctuation z-separator z-rust">,</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>hello<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">assert_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>x<span class="z-punctuation z-separator z-rust">,</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>world<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ã¡ãªã¿ã«ã“ã†ã§ã‚‚OK<br> <code>pub fn strtok<'s>(s: &'_ mut &'s str, delimiter: char) -> &'s str {/* */}</code><h3 id=evil-feeder><a aria-label="Anchor link for: evil-feeder" class=zola-anchor href=#evil-feeder><code>evil_feeder</code></a></h3><p>æ¬¡ã«nomiconã®ä¾‹ã‚’ã¿ã¦ã¿ã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">evil_feeder</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span>T<span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">input</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> T, <span class="z-variable z-parameter z-rust">val</span><span class="z-punctuation z-separator z-rust">:</span> T</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-operator z-arithmetic z-rust">*</span>input <span class="z-keyword z-operator z-assignment z-rust">=</span> val<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> mr_snuggles<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'static</span> <span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>meow! :3<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span><span class="z-punctuation z-terminator z-rust">;</span>  <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> mr. snuggles forever!!
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> spike <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">String</span><span class="z-meta z-path z-rust"><span class="z-punctuation z-accessor z-rust">::</span></span>from<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span>bark! >:V<span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> spike_str<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span>spike<span class="z-punctuation z-terminator z-rust">;</span>                <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Only lives for the block
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-function z-rust">evil_feeder</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> mr_snuggles<span class="z-punctuation z-separator z-rust">,</span> spike_str</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> EVIL!
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> mr_snuggles<span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>                     <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Use after free?
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><p>ã“ã®ä¾‹ã‚‚ä»¥ä¸‹ã®ã‚ˆã†ã«è§£é‡ˆã•ã‚Œã¦compile errorã«ãªã‚Šã¾ã™ã€‚<pre class=z-code><code><span class="z-text z-plain">// signature: &'a mut T           , T
</span><span class="z-text z-plain">// providing: &'a mut &'static str, &'spike str
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">// signature: &'a mut &'static str, &'static str
</span><span class="z-text z-plain">// providing: &'a mut &'static str, &'spike str
</span></code></pre><p>ã¨ãªã£ã¦ã€<code>&'static str</code>ã«<code>&'spike str</code>ã¯æ¸¡ã›ãªããªã‚Šã¾ã™ã€‚<h3 id=messagecollector><a aria-label="Anchor link for: messagecollector" class=zola-anchor href=#messagecollector><code>MessageCollector</code></a></h3><p>æœ€å¾Œã«<a href=https://github.com/sunshowers-code/lifetime-variance>lifetime-variance-example</a>ã«ã®ã£ã¦ã„ãŸå®Ÿéš›ã«é­é‡ã—ãã†ãª<code>&mut</code>ã®varianceãŒå½±éŸ¿ã™ã‚‹ä¾‹ã‚’ã¨ã‚Šã‚ã’ã¾ã™ã€‚ãƒªãƒ³ã‚¯å…ˆã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ˆã‚Šè©³ç´°ã«step by stepã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">collections<span class="z-punctuation z-accessor z-rust">::</span></span>HashSet<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span>fmt<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">Message</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'msg</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">message</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'msg</span> <span class="z-storage z-type z-rust">str</span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">MessageDisplayer</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">list</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">Message<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>,
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> <span class="z-meta z-path z-rust">fmt<span class="z-punctuation z-accessor z-rust">::</span></span>Display <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">MessageDisplayer</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">fmt</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">f</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-meta z-path z-rust">fmt<span class="z-punctuation z-accessor z-rust">::</span></span>Formatter</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-></span> <span class="z-meta z-path z-rust">fmt<span class="z-punctuation z-accessor z-rust">::</span></span>Result</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">for</span> message <span class="z-keyword z-operator z-rust">in</span> <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>list <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-support z-macro z-rust">write!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust">f,</span><span class="z-meta z-group z-rust"> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{}</span><span class="z-constant z-character z-escape z-rust">\n</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> message<span class="z-punctuation z-accessor z-dot z-rust">.</span>message<span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-type z-rust">Ok</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">MessageCollector</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">list</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">Message<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">MessageCollector</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">add_message</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">message</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Message<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>list<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>message</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">collect_and_display</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'msg</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">message_pool</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'msg</span> <span class="z-meta z-generic z-rust">HashSet<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> list <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-macro z-rust">vec!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> collector <span class="z-keyword z-operator z-assignment z-rust">=</span> MessageCollector <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> list<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> list </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-keyword z-control z-rust">for</span> message <span class="z-keyword z-operator z-rust">in</span> message_pool <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        collector<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">add_message</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>Message <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> message </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> displayer <span class="z-keyword z-operator z-assignment z-rust">=</span> MessageDisplayer <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> list<span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&</span>list </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">println!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">"</span><span class="z-constant z-other z-placeholder z-rust">{}</span><span class="z-punctuation z-definition z-string z-end z-rust">"</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-separator z-rust">,</span> displayer<span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><pre class=z-code><code><span class="z-text z-plain">error[E0502]: cannot borrow `list` as immutable because it is also borrowed as mutable
</span><span class="z-text z-plain">  --> src/main.rs:39:46
</span><span class="z-text z-plain">   |
</span><span class="z-text z-plain">34 |     let mut collector = MessageCollector { list: &mut list };
</span><span class="z-text z-plain">   |                                                  --------- mutable borrow occurs here
</span><span class="z-text z-plain">...
</span><span class="z-text z-plain">39 |     let displayer = MessageDisplayer { list: &list };
</span><span class="z-text z-plain">   |                                              ^^^^^
</span><span class="z-text z-plain">   |                                              |
</span><span class="z-text z-plain">   |                                              immutable borrow occurs here
</span><span class="z-text z-plain">   |                                              mutable borrow later used here
</span></code></pre><p>å•é¡Œã¯<code>MessageCollector</code>ã®å®šç¾©ã«ã‚ã‚Šã¾ã™ã€‚<pre class=z-code><code><span class="z-text z-plain">struct MessageCollector<'a> {
</span><span class="z-text z-plain">    list: &'a mut Vec&LTMessage<'a>>
</span><span class="z-text z-plain">}
</span></code></pre><p><code> collector.add_message(Message { message });</code> ã“ã“ã®messageã®lifetimeãŒé–¢æ•°å…¨ä½“ã«åŠã¶ã®ã§ã²ãã¥ã‚‰ã‚Œã¦<code>MessageCollector</code>ã®listã«å¯¾ã™ã‚‹<code>&mut</code>å‚ç…§ã‚‚é–¢æ•°å…¨ä½“ã«ãŠã‚ˆã³ã€compilerãŒ<code>&mut</code>ã®lifetimeã‚’ç¸®ã‚ã‚‹ã“ã¨ãŒã§ããªããªã£ã¦ã—ã¾ã„ã€immutable refãŒã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚<p><code>MessageCollector</code>ã®å®šç¾©ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã¨compileãŒã¨ãŠã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<pre class="language-rust z-code" data-lang=rust><code class=language-rust data-lang=rust><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-generic z-rust"><span class="z-entity z-name z-struct z-rust">MessageCollector2</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span>, <span class="z-storage z-modifier z-lifetime z-rust">'msg</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span></span><span class="z-meta z-struct z-rust"> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-other z-member z-rust">list</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span> <span class="z-storage z-modifier z-rust">mut</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-meta z-generic z-rust">Message<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'msg</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span>,<span class="z-storage z-modifier z-lifetime z-rust">'msg</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">MessageCollector2</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'a</span>,<span class="z-storage z-modifier z-lifetime z-rust">'msg</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">add_message</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">message</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">Message<span class="z-punctuation z-definition z-generic z-begin z-rust"><</span><span class="z-storage z-modifier z-lifetime z-rust">'msg</span><span class="z-punctuation z-definition z-generic z-end z-rust">></span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">        <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>list<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>message</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre><h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><ul><li><code>&</code>,<code>&mut</code>ã¯type converterã¨è€ƒãˆã‚‹ã¨ã„ã‚ã„ã‚compilerã®æŒ™å‹•ã®èª¬æ˜ãŒã¤ãã€‚<li><code>&mut</code>ã«ãŠã‘ã‚‹å±é™ºãªæ“ä½œãŒinvariantã¨ã—ã¦ç¦æ­¢ã•ã‚Œã¦ã„ãŸã‚Šã¨lifetimeãŒå‹ã¨ã—ã¦è¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ã€‚<li>Drop checkã®æŒ™å‹•ã‚’åˆ¶å¾¡ã—ãŸã‚Šã™ã‚‹é–¢ä¿‚ã§ã€<code>PhantomData</code>ç­‰ã§å‹ã®varianceã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹ã¿ãŸã„ãªãƒˆãƒ”ãƒƒã‚¯ã«ã¤ã„ã¦ã¯ã¾ã ã¾ã ã‚ã‹ã£ã¦ã„ãªã„ã€‚</ul></div></article></main><footer class=blog-footer><p>Â© 2024 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>